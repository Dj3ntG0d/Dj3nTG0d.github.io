<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Thinkphp5框架实现以及生命周期源码分析 | Dj3ntG0d's Blog</title><meta name="description" content="# 0x00 前言​    之前在论坛发现一套TP5框架的laysns的cms，调试过程中发现一些问题，加上打算好好学习代码审计,也没有认真分析过TP5这个框架到底做了什么,此前都是看一些简略文档介绍路由等的操作,为了加深自己对框架的认识,对web程序的认识,索性对整个ThinkPHP5的生命周期做一次源码跟踪分析。 # 0x01 程序安装来到index.php， 首先检测安装锁的存在，不存在则去"><meta name="keywords" content="php,代码审计"><meta name="author" content="Dj3ntG0d"><meta name="copyright" content="Dj3ntG0d"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Thinkphp5框架实现以及生命周期源码分析"><meta name="twitter:description" content="# 0x00 前言​    之前在论坛发现一套TP5框架的laysns的cms，调试过程中发现一些问题，加上打算好好学习代码审计,也没有认真分析过TP5这个框架到底做了什么,此前都是看一些简略文档介绍路由等的操作,为了加深自己对框架的认识,对web程序的认识,索性对整个ThinkPHP5的生命周期做一次源码跟踪分析。 # 0x01 程序安装来到index.php， 首先检测安装锁的存在，不存在则去"><meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Thinkphp5框架实现以及生命周期源码分析"><meta property="og:url" content="https://dj3ntg0d.github.io/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="Dj3ntG0d's Blog"><meta property="og:description" content="# 0x00 前言​    之前在论坛发现一套TP5框架的laysns的cms，调试过程中发现一些问题，加上打算好好学习代码审计,也没有认真分析过TP5这个框架到底做了什么,此前都是看一些简略文档介绍路由等的操作,为了加深自己对框架的认识,对web程序的认识,索性对整个ThinkPHP5的生命周期做一次源码跟踪分析。 # 0x01 程序安装来到index.php， 首先检测安装锁的存在，不存在则去"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2020-06-23T08:30:37.000Z"><meta property="article:modified_time" content="2020-07-03T11:05:38.439Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://dj3ntg0d.github.io/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="prev" title="Laysns注册登录逻辑分析及任意用户登录--注册篇" href="https://dj3ntg0d.github.io/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">3</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text"># 0x00 前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-程序安装"><span class="toc-number">2.</span> <span class="toc-text"># 0x01 程序安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#"><span class="toc-number">2.1.</span> <span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X02-index-php入口文件"><span class="toc-number">3.</span> <span class="toc-text"># 0X02 index.php入口文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#start-php"><span class="toc-number">3.1.</span> <span class="toc-text"># start.php</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#base-php"><span class="toc-number">3.2.</span> <span class="toc-text">#  base.php</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Loader-register"><span class="toc-number">3.2.1.</span> <span class="toc-text">#  Loader::register()</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#自动加载类的过程："><span class="toc-number">3.2.1.1.</span> <span class="toc-text"># 自动加载类的过程：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加载配置"><span class="toc-number">3.3.</span> <span class="toc-text">#  加载配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X03-App类的run方法"><span class="toc-number">4.</span> <span class="toc-text"># 0X03 App类的run方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-App-routeCheck-路由检测"><span class="toc-number">5.</span> <span class="toc-text"># 0x04 App::routeCheck() 路由检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#path"><span class="toc-number">5.1.</span> <span class="toc-text"># path()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Route-import-rules-注册路由"><span class="toc-number">5.2.</span> <span class="toc-text"># Route::import($rules)  注册路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Route-check-request-path-depr-config-‘url-domain-deploy’"><span class="toc-number">5.3.</span> <span class="toc-text"># Route::check($request,$path,$depr,$config[‘url_domain_deploy’])</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1"><span class="toc-number">5.4.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Route-checkRoute-request-rules-存的是当前请求方法的路由允许状况数组-url-pathinfo-depr"><span class="toc-number">5.5.</span> <span class="toc-text"># Route::checkRoute($request,$rules(存的是当前请求方法的路由允许状况数组),$url(pathinfo),$depr)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Route-parseUrl-path-depr-config-‘controller-auto-search’"><span class="toc-number">5.6.</span> <span class="toc-text"># Route::parseUrl($path, $depr, $config[‘controller_auto_search’])</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URL转换成路由调度信息的实现"><span class="toc-number">5.7.</span> <span class="toc-text"># URL转换成路由调度信息的实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-exec"><span class="toc-number">6.</span> <span class="toc-text"># 0x05 exec</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#module-三要素数组，-config，null"><span class="toc-number">6.1.</span> <span class="toc-text"># module(三要素数组，$config，null)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-Loader-controller-加载控制器"><span class="toc-number">7.</span> <span class="toc-text"># 0x06 Loader::controller() 加载控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#App-invokeClass-class"><span class="toc-number">7.1.</span> <span class="toc-text"># App::invokeClass($class)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#View-对象初始化"><span class="toc-number">7.2.</span> <span class="toc-text"># View 对象初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HomeBase-getSystem"><span class="toc-number">7.3.</span> <span class="toc-text"># HomeBase   :  getSystem()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HomeBase-systemlogin"><span class="toc-number">7.4.</span> <span class="toc-text">#  HomeBase   :  systemlogin()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#session助手函数全过程。"><span class="toc-number">7.4.1.</span> <span class="toc-text"># session助手函数全过程。</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回到systemlogin"><span class="toc-number">7.5.</span> <span class="toc-text"># 回到systemlogin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sys-key-的-cookie-解密函数-decrypt-加密encrypt-以及登录逻辑"><span class="toc-number">7.6.</span> <span class="toc-text"># sys_key 的 cookie 解密函数 decrypt() ,加密encrypt(),以及登录逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回到systemlogin-1"><span class="toc-number">7.7.</span> <span class="toc-text"># 回到systemlogin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回到-initialize"><span class="toc-number">7.8.</span> <span class="toc-text"># 回到_initialize</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x07-通过getNav-nav-cms-0-获取nav-cms0-–跟进DB查询逻辑和实现"><span class="toc-number">8.</span> <span class="toc-text"># 0x07 通过getNav(nav_cms,0),  获取nav_cms0 –跟进DB查询逻辑和实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Db-callStatic函数的用处是什么呢"><span class="toc-number">8.1.</span> <span class="toc-text"># Db::__callStatic函数的用处是什么呢?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回到where方法"><span class="toc-number">8.2.</span> <span class="toc-text"># 回到where方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#order-方法"><span class="toc-number">8.3.</span> <span class="toc-text"># order 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select-函数"><span class="toc-number">8.4.</span> <span class="toc-text"># select()函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回到-initialize函数"><span class="toc-number">8.5.</span> <span class="toc-text"># 回到_initialize函数,</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x08-action-方法-Index"><span class="toc-number">9.</span> <span class="toc-text"># 0x08  action 方法 Index</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#return-view"><span class="toc-number">9.1.</span> <span class="toc-text"># return view()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x09-Response类"><span class="toc-number">10.</span> <span class="toc-text"># 0x09 Response类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Response-View-gt-replace方法-进行视图内容的替换"><span class="toc-number">10.1.</span> <span class="toc-text"># Response&#x2F;View-&gt;replace方法.进行视图内容的替换</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x0B-send"><span class="toc-number">11.</span> <span class="toc-text"># 0x0B send()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#think-View的fetch"><span class="toc-number">11.1.</span> <span class="toc-text"># think&#x2F;View的fetch()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x0C-渲染模板文件-模板引擎对象-think-view-driver-Think-的fetch"><span class="toc-number">12.</span> <span class="toc-text"># 0x0C 渲染模板文件.模板引擎对象 think&#x2F;view&#x2F;driver&#x2F;Think 的fetch()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-2"><span class="toc-number">13.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">14.</span> <span class="toc-text"># 总结</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Dj3ntG0d's Blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Thinkphp5框架实现以及生命周期源码分析</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-06-23 16:30:37"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-06-23</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-07-03 19:05:38"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-07-03</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="# 0x00 前言"></a># 0x00 前言</h3><p>​    之前在论坛发现一套TP5框架的laysns的cms，调试过程中发现一些问题，加上打算好好学习代码审计,也没有认真分析过TP5这个框架到底做了什么,此前都是看一些简略文档介绍路由等的操作,为了加深自己对框架的认识,对web程序的认识,索性对整个ThinkPHP5的生命周期做一次源码跟踪分析。</p>
<h3 id="0x01-程序安装"><a href="#0x01-程序安装" class="headerlink" title="# 0x01 程序安装"></a># 0x01 程序安装</h3><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200623175637135.png" alt="image-20200623175637135">来到index.php，</p>
<p>首先检测安装锁的存在，不存在则去安装界面。</p>
<h4 id><a href="#" class="headerlink" title></a><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200623181206357.png" alt="image-20200623181206357"></h4><p>​    前面填写一些信息,属于安装的常规操作,用于数据库连接,生成数据库表前缀等等配置信息的填写，有个值得注意的地方是这里。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200623182145498.png" alt="image-20200623182145498"></p>
<p>​    在27行开始,在安装成功时,定义了参数  <strong>$password</strong>  = <strong>5位随机大小写字母字符串</strong> ，接下来对一些参数进行格式化校验，最后会在当前<strong>$_SESSION[‘adminusername’]</strong>赋值管理员用户名，并且 <strong>$user</strong>也被赋值为管理员用户名。</p>
<p>​    接下来出现重要参数 <strong>$salt</strong>  ，可以看到由<strong>一个硬编码字符串</strong>拼接上面的5位随机字符串 <strong>$password</strong> 而成。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$salt=<span class="string">'xLhiuLqn'</span>. $password;</span><br></pre></td></tr></table></figure>

<p>​    这个盐值再本人跟进完整个生命周期都未发现这个盐的作用，后续分析业务逻辑的时候会进行分析。（论坛上的那篇分析任意用户登录的文章就是利用了该盐的硬编码特性，导致盐的泄露造成漏洞）</p>
<p>​    接下来的<strong>$pass</strong> 管理员密码为  <em>md5（管理员明文密码</em> + <em>盐）</em> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$pass = md5($data[<span class="string">'admin_pass'</span>].$salt);</span><br></pre></td></tr></table></figure>

<p>​    最后还有一个叫做安全验证码的东西。<strong>$code</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$code = $data[<span class="string">'code'</span>];</span><br></pre></td></tr></table></figure>

<p>​    下面的就是对数据库进行初始化的操作。下面这里</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200623184230584.png" alt="image-20200623184230584"></p>
<p>​    发现，数据库admin_user表中存了 $username，密文$pass， 盐$salt , 安全码 $code 。</p>
<p>​    下面的操作就是对一些数据库配置文件，session配置文件，缓存配置文件，cookie配置文件进行内容写入，发现</p>
<p><strong>$password</strong>  这个五位随机字符串被作为各种配置的前缀，如session,cache,cookie.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200623185215919.png" alt="image-20200623185215919"></p>
<p>​    最终安装成功，生成Lock文件。    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">安装流程小结：值得重点关注的有<span class="number">3</span>个参数：$password， $salt，$pass。</span><br><span class="line"></span><br><span class="line">$password为<span class="number">5</span>个随机字母生成，用作生成盐值，用作各种配置的前缀。（是不是意味着看cookie前缀能获得这个值？）</span><br><span class="line"></span><br><span class="line">$salt 盐值是硬编码字符串拼接$password生成的，数据库里面保存的管理员密码也是盐值加密的。（是否获得$password就能拿到$salt的值？）</span><br><span class="line"></span><br><span class="line">$pass 为管理员密码，是由md5($data[<span class="string">'admin_pass'</span>].$salt)  生成。</span><br></pre></td></tr></table></figure>



<h3 id="0X02-index-php入口文件"><a href="#0X02-index-php入口文件" class="headerlink" title="# 0X02 index.php入口文件"></a># 0X02 index.php入口文件</h3><p>访问 <a href="http://phplearning:9001/index.php?a=1&amp;b=2" target="_blank" rel="noopener">http://phplearning:9001/index.php?a=1&amp;b=2</a></p>
<p>安装流程走完回到入口文件</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200623175637135.png" alt="image-20200623175637135"></p>
<p>定义各种常量，为后面加载做准备。然后加载start.php，加载引导文件，进行跟进。</p>
<h4 id="start-php"><a href="#start-php" class="headerlink" title="# start.php"></a># start.php</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200623193941387.png" alt="image-20200623193941387"></p>
<p>继续跟进base.php</p>
<h4 id="base-php"><a href="#base-php" class="headerlink" title="#  base.php"></a>#  base.php<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624065829654.png" alt="image-20200624065829654"></h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624065849324.png" alt="image-20200624065849324"></p>
<p>文件开头定义了一堆常量，用于后面的路径寻找以及命名空间自动加载等。</p>
<p>38行require了加载类文件，跟进文件发现有autoload自动加载方法，后面是对这个方法进行注册的，用于在程序执行过程中加载一些没有加载进来的类，自动通过命名空间去寻找。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624071010680.png" alt="image-20200624071010680"></p>
<p>判断是否有环境变量文件，程序默认是没有的。接着来到注册自动加载，就是这一步对上面的Loader类处理，跟进register方法。</p>
<h5 id="Loader-register"><a href="#Loader-register" class="headerlink" title="#  Loader::register()"></a>#  Loader::register()</h5><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624071228187.png" alt="image-20200624071228187"></p>
<p>首先注册自动加载函数为<strong>Loader::autoload</strong> 也就是以后只要尝试加载未定义的类都会调用autoload函数。下面的composer目录默认不存在，加载composer的，跳过。</p>
<p>**<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624071607921.png" alt="image-20200624071607921">)<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624072054871.png" alt="image-20200624072054871"></p>
<p><strong>self::addNamespace</strong> 为添加命名空间方法。根据传入的参数，如这里传入一个数组，进入到下面去遍历每一个关联数组的元素拿到$prefix和$paths，然后调用<strong>addPsr4</strong>方法，结果就是在<strong>Loader::$prefixDirPsr4[$prefix]</strong> 这个数组里面进行记录了各种命名空间对应的路径，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Loader::$prefixDirPsr4[&#39;think\&#39;] &#x3D; &#x2F;library&#x2F;think&#x2F;</span><br></pre></td></tr></table></figure>

<p>这里定义了3个命名空间的路径，think,travits,behavior 。以后文件中出现think，就代表着这个路径了。以及<strong>$prefixLengthsPsr4[$prefix[0]] [$prefix] = $length;</strong> 这个前缀长度二维数组，一维是前缀的第一个字符，对应的是前缀和长度，如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$prefixLengthsPsr4[<span class="string">'t'</span>] [<span class="string">'think\'] = 5</span></span><br></pre></td></tr></table></figure>





<p>回到register方法，<strong>self::loadComposerAutoloadFiles();</strong>这个方法用于加载composer，跳过。最后定义了一个extend目录路径  <strong>self::$fallbackDirsPsr4[]</strong>。</p>
<h6 id="自动加载类的过程："><a href="#自动加载类的过程：" class="headerlink" title="# 自动加载类的过程："></a># 自动加载类的过程：</h6><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624073626915.png" alt="image-20200624073626915"></p>
<p>当使用了一个未定义过的类时，会先去执行autoload方法，参数为 <strong>命名空间\类名 **，进来后，执行</strong>Loader::findFile($class)**去找到类文件，如果找到return ture。</p>
<p><strong>findFile($class)</strong> <img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624073930241.png" alt="image-20200624073930241"></p>
<p>正常来说，要调用一些定义的类，必须要存在同一个命名空间下，如在namespace think下调用就必须那么这个类的dir必定存在于命名空间think中（前提是think命名空间都注册过）。如<strong>start.php</strong>在think下，调用App类方法，此时自动加载的类会变成 <strong>think\App</strong>。</p>
<p>所以根据上面的特性，首先判断当前命名空间首字母，看是否有注册过命名空间前缀长度，并且针对下面的所有的</p>
<p><strong>$prefix=&gt;$length</strong>进行判断，如果$class 是以$prefix前缀开头的，那么就对<strong>self::$prefixDirsPsr4[$prefix]</strong>这个数组，去取到路径，然后去这个路径下面找是否有这个类文件，找到后把文件路径返回。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">register()方法小结：</span><br><span class="line">1.注册了通过spl_autoload_register 注册自动加载方法autoload.</span><br><span class="line">2.注册了3个命名空间,分别为think behaviour traits</span><br></pre></td></tr></table></figure>

<p>回到base.php，<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624081039417.png" alt="image-20200624081039417" style="zoom:200%;"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624092445239.png" alt="image-20200624092445239"></p>
<p>注册了一些异常方法，比如appShutdown，在最后程序结束的时候会自动执行，且看到默认开启报错模式。</p>
<h4 id="加载配置"><a href="#加载配置" class="headerlink" title="#  加载配置"></a>#  加载配置</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624093215142.png" alt="image-20200624093215142"></p>
<p>跟进set方法<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624093233571.png" alt="image-20200624093233571"></p>
<p>可以看到set的配置文件是convention.php文件，里面都是一些惯例配置。进来之后，最终结果是将<strong>convention</strong>配置中的<strong>配置信息数组</strong>都保存到 <strong>self::$config[$range]</strong>里面，$range默认是<strong>sys</strong> 系统作用域，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Config::$config[__sys__][&#39;session&#39;]&#x3D; [xx,xx,xx] 以此方式来存储配置文件</span><br></pre></td></tr></table></figure>

<p>之后在后面需要用到这些配置的时候，因为<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624094254983.png" alt="image-20200624094254983"></p>
<p>为私有静态变量，则通过<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624094317525.png" alt="image-20200624094317525"></p>
<p>get接口去获取配置信息即可。</p>
<h3 id="0X03-App类的run方法"><a href="#0X03-App类的run方法" class="headerlink" title="# 0X03 App类的run方法"></a># 0X03 App类的run方法</h3><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624095930999.png" alt="image-20200624095930999"></p>
<p>run方法通过执行应用，获取返回数据，然后send方法从返回的对象中获取到模板编译后的php文件。</p>
<p>跟进run方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行应用程序</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  Request $request 请求对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(Request $request = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $request = is_null($request) ? Request::instance() : $request;<span class="comment">//实例化request类</span></span><br><span class="line">        <span class="comment">//获得一个$request 的 Request对象 ,里面有请求的各种信息,路由呀什么的,但是这里初始化是空的.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $config = <span class="keyword">self</span>::initCommon();</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                1.将本地的命名空间 app =&gt; APP_PATH 注册到命名空间里面去,用于后续在本命名空间下的类可以自动加载</span></span><br><span class="line"><span class="comment">                2.加载公共文件 common.php 很多公共方法</span></span><br><span class="line"><span class="comment">                3.返回 获取前面所有加载的配置.并返回给$config  包括: 数据库配置 // 模块配置(如果有) // 扩展目录下面的所有配置 // 应用状态配置 //行为扩展文件 //  语言包</span></span><br><span class="line"><span class="comment">                4.开启debug模式</span></span><br><span class="line"><span class="comment">                5.include 助手文件 helper.php</span></span><br><span class="line"><span class="comment">                6.监听 app_init  执行app_init状态注册了的函数的run方法</span></span><br><span class="line"><span class="comment">                7.将所有前面加载的配置都读取出来 返回给$config</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="comment">// 模块/控制器绑定  不执行这块</span></span><br><span class="line">            <span class="keyword">if</span> (defined(<span class="string">'BIND_MODULE'</span>)) &#123;</span><br><span class="line">                BIND_MODULE &amp;&amp; Route::bind(BIND_MODULE);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> ($config[<span class="string">'auto_bind_module'</span>]) &#123;</span><br><span class="line">                <span class="comment">// 入口自动绑定</span></span><br><span class="line">                $name = pathinfo($request-&gt;baseFile(), PATHINFO_FILENAME);</span><br><span class="line">                <span class="keyword">if</span> ($name &amp;&amp; <span class="string">'index'</span> != $name &amp;&amp; is_dir(APP_PATH . $name)) &#123;</span><br><span class="line">                    Route::bind($name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $request-&gt;filter($config[<span class="string">'default_filter'</span>]); <span class="comment">// 默认 $config['default_filter']是空的</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 默认语言</span></span><br><span class="line">            Lang::range($config[<span class="string">'default_lang'</span>]);</span><br><span class="line">            <span class="comment">// 开启多语言机制 检测当前语言</span></span><br><span class="line">            $config[<span class="string">'lang_switch_on'</span>] &amp;&amp; Lang::detect();</span><br><span class="line">            $request-&gt;langset(Lang::range());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 加载系统语言包</span></span><br><span class="line">            Lang::load([</span><br><span class="line">                THINK_PATH . <span class="string">'lang'</span> . DS . $request-&gt;langset() . EXT,</span><br><span class="line">                APP_PATH . <span class="string">'lang'</span> . DS . $request-&gt;langset() . EXT,</span><br><span class="line">            ]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 监听 app_dispatch</span></span><br><span class="line">            Hook::listen(<span class="string">'app_dispatch'</span>, <span class="keyword">self</span>::$dispatch); <span class="comment">//空的 默认app_dispatch 没有行为</span></span><br><span class="line">            <span class="comment">// 获取应用调度信息</span></span><br><span class="line">            $dispatch = <span class="keyword">self</span>::$dispatch;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 未设置调度信息则进行   ***路由检测*** </span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($dispatch)) &#123;</span><br><span class="line">                $dispatch = <span class="keyword">self</span>::routeCheck($request, $config);<span class="comment">// 最终返回的是一个数组  ['type'=&gt;'module','route'=&gt; $route(数组,存了3要素信息)]</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录当前调度信息</span></span><br><span class="line">            $request-&gt;dispatch($dispatch); <span class="comment">//把调度信息存到$request的dispatch变量中</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录路由和请求信息</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>::$debug) &#123;</span><br><span class="line">                Log::record(<span class="string">'[ ROUTE ] '</span> . var_export($dispatch, <span class="keyword">true</span>), <span class="string">'info'</span>);</span><br><span class="line">                Log::record(<span class="string">'[ HEADER ] '</span> . var_export($request-&gt;header(), <span class="keyword">true</span>), <span class="string">'info'</span>);</span><br><span class="line">                Log::record(<span class="string">'[ PARAM ] '</span> . var_export($request-&gt;param(), <span class="keyword">true</span>), <span class="string">'info'</span>);<span class="comment">//这一步是给request传参数的.并写入日志</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 监听 app_begin</span></span><br><span class="line">            Hook::listen(<span class="string">'app_begin'</span>, $dispatch);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 请求缓存检查</span></span><br><span class="line">            $request-&gt;cache(</span><br><span class="line">                $config[<span class="string">'request_cache'</span>], <span class="comment">//默认没开缓存</span></span><br><span class="line">                $config[<span class="string">'request_cache_expire'</span>],</span><br><span class="line">                $config[<span class="string">'request_cache_except'</span>]</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            $data = <span class="keyword">self</span>::exec($dispatch, $config);<span class="comment">//最后返回的东西为resp.view对象,控制器对象在里面已经初始化了,但是没有返回出来,只返回了执行方法后的对象.</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (HttpResponseException $exception) &#123;</span><br><span class="line">            $data = $exception-&gt;getResponse();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清空类的实例化</span></span><br><span class="line">        Loader::clearInstance();<span class="comment">//清除加载器的实例</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输出数据到客户端 $data的返回类型</span></span><br><span class="line">        <span class="keyword">if</span> ($data <span class="keyword">instanceof</span> Response) &#123;</span><br><span class="line">            $response = $data;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (!is_null($data)) &#123;</span><br><span class="line">            <span class="comment">// 默认自动识别响应输出类型</span></span><br><span class="line">            $type = $request-&gt;isAjax() ?</span><br><span class="line">            Config::get(<span class="string">'default_ajax_return'</span>) :</span><br><span class="line">            Config::get(<span class="string">'default_return_type'</span>);</span><br><span class="line"></span><br><span class="line">            $response = Response::create($data, $type);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $response = Response::create();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听 app_end</span></span><br><span class="line">        Hook::listen(<span class="string">'app_end'</span>, $response);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;<span class="comment">//把Resp.view对象返回.</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>run方法中包括了加载各种配置，路由检测获取路由，初始化控制器，初始化.</p>
<p>初始化request对象，是一个空的request对象，后续会存一些路由信息等请求相关的信息到这个对象。进入配置初始化</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200624234656933.png" alt="image-20200624234656933"></p>
<p><strong>self::initCommon</strong>  所做的所有操作包括：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.将本地的命名空间 app =&gt; APP_PATH 注册到命名空间里面去,用于后续在本命名空间下的类可以自动加载</span><br><span class="line">2.加载公共文件 common.php 很多公共方法</span><br><span class="line">3.返回 获取前面所有加载的配置.并返回给$config  包括: 数据库配置 // 扩展目录下面的所有配置 // 应用状态配置 //行为扩展文件 //  语言包</span><br><span class="line">4.开启debug模式</span><br><span class="line">5.include 助手文件 helper.php</span><br><span class="line">6.监听 app_init  执行app_init状态注册了的函数的run方法</span><br><span class="line">7.将所有前面加载的配置都读取出来 返回给$config</span><br></pre></td></tr></table></figure>

<p>接着判断模块控制器绑定，这个常量在admin.php页面是有绑定的，index.php主页没有定义这个常量。跳过此分支。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200625000227313.png" alt="image-20200625000227313"></p>
<p>上图中的过滤器filter默认是空的，不对输入做任何过滤，后续是否有addslashes等操作再深究。<em>（后面测试输入是否做特殊处理）</em>。加载各种语言包，我们不关心直接跳过。</p>
<p>下面出现了Hook::listen方法，是钩子函数触发的方法，当执行这个方法时，会去调用tags.php中注册过的钩子类的run方法。这套程序只有app_init有注册钩子函数，其他都是空的。下面来到关键的获取调度信息，路由检测步骤。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200625002130893.png" alt></p>
<p>进入路由检测阶段。</p>
<h3 id="0x04-App-routeCheck-路由检测"><a href="#0x04-App-routeCheck-路由检测" class="headerlink" title="# 0x04 App::routeCheck() 路由检测"></a># 0x04 App::routeCheck() 路由检测</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$dispatch = <span class="keyword">self</span>::routeCheck($request, $config);</span><br></pre></td></tr></table></figure>

<p>进入routeCheck方法。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200626092210605.png" alt="image-20200626092210605"></p>
<p>关键方法：667行path()方法，685行路由导入，696行路由检测 <em>静态路由和分组路由</em> ，712行parseURL()。</p>
<h4 id="path"><a href="#path" class="headerlink" title="# path()"></a># <strong>path()</strong></h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200626113308015.png" alt="image-20200626113308015"></p>
<p>通过一些格式的处理最后获取到PATH_INFO的值，如<a href="http://127.0.0.1/index.php/admin/admin/admin" target="_blank" rel="noopener">http://127.0.0.1/index.php/admin/admin/admin</a> 最后获取到 $path  = admin/admin/admin 。 </p>
<p>获取到path_info后去到路由检测分支。默认是没有路由缓存的，到else分支。首先找到配置中的路由配置文件路径，在app路径中找到路由文件如下图，再include进来$rules，然后对$rules进行路由导入。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200626143643647.png" alt="image-20200626143643647"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200626144100548.png" alt="image-20200626144100548"></p>
<h4 id="Route-import-rules-注册路由"><a href="#Route-import-rules-注册路由" class="headerlink" title="# Route::import($rules)  注册路由"></a># <strong>Route::import($rules)</strong>  注册路由</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200626144141481.png" alt="image-20200626144141481"> </p>
<p>此方法执行的操作$rule是路由文件的关联数组，表示路由规则，传入import中，对路由进行解析，将配置放到Route::$rules[‘pattern’] 中。下面去到Route::registerRules(<strong>$rule(这个是路由规则数组)</strong>,$type)方法。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628094828872.png" alt="image-20200628094828872"></p>
<p>跟进Route::registerRules($rule,$type)：遍历每一条路由规则，去到220行的setRule()，跟进：</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628095239731.png" alt="image-20200628095239731"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628095313895.png" alt="image-20200628095313895">)这个setRule方法，是每一个路由规则都要执行一次，所有$rule代表当前路由规则的key，$route代表路由内容，接着进行格式规范化，322行下面执行Route::parseVar($rule)</p>
<p>解析路由规则key的参数，取出路由key问号后面的参数，就不跟进了，获取结果如key等于index?abc=555 返回一个关联数组，则$vars = [ ‘abc’ =&gt; ‘556’ ]</p>
<p>前面我们看到$name = $route 已经赋值给$name了，则$name为路由内容。(index/index/index) ，$group是空的这里，所有导入路由规则如果路由key不以中括号 <strong>[</strong> 开头，而使用的setRule方法，$group都为空，都不会是分组路由。$name直接进入324行分支，关键是执行到326行的Route::name方法，传入路由内容，和一堆其他参数。</p>
<p>跟进name方法：执行147行，结果就是赋值，把这些路由信息注册到Route::$rules[‘name’]中。</p>
<p><strong>Route::$rules[‘name’] [路由内容] = [路由key，路由名称中的参数关联数组，路由域名，路由后缀]</strong><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628101951408.png" alt="image-20200628101951408"></p>
<p>最后来到350行，<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628102510255.png" alt="image-20200628102510255"></p>
<p><strong>$type=’*’</strong>是默认的，然后对于每一个请求method，都同步赋值到<strong>Route::$rules[请求方法] [路由key] = true</strong>  结束。这代表一条路由注册设置完毕，结果就是在Route::$rules数组里面进行赋值存储路由规则信息。</p>
<p>所有路由规则都注册同步完毕后，接下来回到routeCheck()方法的696行，开始对请求的进行路由检测。</p>
<h4 id="Route-check-request-path-depr-config-‘url-domain-deploy’"><a href="#Route-check-request-path-depr-config-‘url-domain-deploy’" class="headerlink" title="# Route::check($request,$path,$depr,$config[‘url_domain_deploy’])"></a># Route::check($request,$path,$depr,$config[‘url_domain_deploy’])</h4><h4 id="-1"><a href="#-1" class="headerlink" title></a><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628104253884.png" alt="image-20200628104253884"></h4><p>check方法，传入的$url参数是$path 也就是pathinfo的值，如’/‘ 或者 ‘index/index/index’，判断路由别名，没有跳过，来到872行，看到$request-&gt;method()方法，最终结果获取到请求方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">获取$_SERVER的REQUEST_METHOD函数,如果没有,则默认为GET</span><br><span class="line">&#x2F;&#x2F;是通过input 输入函数去获取$_SERVER的参数并且进行过滤掉一些关键字和执行过滤器(默认没有过滤器)</span><br></pre></td></tr></table></figure>

<p>接着从上面获取到的请求方法里面，去寻找路由规则总数组$rules的此方法的数组 $rules[‘GET’] 这个值对应下面也是关联数组，格式为[路由key =&gt; true]，如果当前方法有允许的路由key在里面，那就保存赋值给$rules ，没有$rules为空。</p>
<p>下面去到880行的URL绑定方法,<strong>Route::checkUrlBind</strong> 传入$path,$rules（当前请求方法的路由规则），$depr，跟进。没有URL绑定返回false。</p>
<p>来到887行，判断<strong>$rules[PATH_INFO]</strong>是否存在，根据传入的pathinfo，判断$rules路由里面是否存在，这里的$rules数组，是存的<strong>当前请求方法GET下的 [路由key=&gt; true/false]</strong> ,即当前路由是否在，默认没有。其实这里是检测静态路由的，因为此时$rules下面存的是 key=&gt;true/false，存的是路由key，这里判断如果pathinfo是跟路由的key相同的话，那么会直接通过<strong>self::getRouteExpress</strong> 方法，返回路由内容。</p>
<h4 id="Route-checkRoute-request-rules-存的是当前请求方法的路由允许状况数组-url-pathinfo-depr"><a href="#Route-checkRoute-request-rules-存的是当前请求方法的路由允许状况数组-url-pathinfo-depr" class="headerlink" title="# Route::checkRoute($request,$rules(存的是当前请求方法的路由允许状况数组),$url(pathinfo),$depr)"></a># Route::checkRoute($request,$rules<em>(存的是当前请求方法的路由允许状况数组)</em>,$url<em>(pathinfo)</em>,$depr)</h4><p>那么我们传入的pathinfo是 ‘ / ‘ ，是没有静态路由的，下面去到901行的路由规则检测，进行路由检测。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkRoute</span><span class="params">($request, $rules, $url, $depr = <span class="string">'/'</span>, $group = <span class="string">''</span>, $options = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($rules <span class="keyword">as</span> $key =&gt; $item) &#123;<span class="comment">//检测路由规则,根据刚刚这个method下面的为 ture  也就是允许这个方法的路由条目,都去getRouteExpress把路由信息读出来给$item,里面有路由内容,路由key,option,和路由参数</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">true</span> === $item) &#123;</span><br><span class="line">            $item = <span class="keyword">self</span>::getRouteExpress($key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($item[<span class="string">'rule'</span>])) &#123;<span class="comment">// 这个是 如果这个路由在当前method  不允许,也就是$rules['路由key']=false 的时候执行的,就是跳过下面的路由参数复制</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//路由参数复制</span></span><br><span class="line">        $rule    = $item[<span class="string">'rule'</span>];</span><br><span class="line">        $route   = $item[<span class="string">'route'</span>];</span><br><span class="line">        $vars    = $item[<span class="string">'var'</span>];</span><br><span class="line">        $option  = $item[<span class="string">'option'</span>];</span><br><span class="line">        $pattern = $item[<span class="string">'pattern'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查参数有效性 参数有效才能进行后面对参数进行处理的操作</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>::checkOption($option, $request)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($option[<span class="string">'ext'</span>])) &#123;</span><br><span class="line">            <span class="comment">// 路由ext参数 优先于系统配置的URL伪静态后缀参数</span></span><br><span class="line">            $url = preg_replace(<span class="string">'/\.'</span> . $request-&gt;ext() . <span class="string">'$/i'</span>, <span class="string">''</span>, $url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array($rule)) &#123;</span><br><span class="line">            <span class="comment">// 分组路由</span></span><br><span class="line">            $pos = strpos(str_replace(<span class="string">'&lt;'</span>, <span class="string">':'</span>, $key), <span class="string">':'</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span> !== $pos) &#123;</span><br><span class="line">                $str = substr($key, <span class="number">0</span>, $pos);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $str = $key;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is_string($str) &amp;&amp; $str &amp;&amp; <span class="number">0</span> !== stripos(str_replace(<span class="string">'|'</span>, <span class="string">'/'</span>, $url), $str)) &#123; <span class="comment">//路由key如果有 '/' ,才能继续,没有/,不能继续</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">self</span>::setOption($option);</span><br><span class="line">            $result = <span class="keyword">self</span>::checkRoute($request, $rule, $url, $depr, $key, $option);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span> !== $result) &#123;</span><br><span class="line">                <span class="keyword">return</span> $result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($route) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">'__miss__'</span> == $rule || <span class="string">'__auto__'</span> == $rule) &#123;</span><br><span class="line">                <span class="comment">// 指定特殊路由</span></span><br><span class="line">                $var    = trim($rule, <span class="string">'__'</span>);</span><br><span class="line">                $&#123;$var&#125; = $item;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($group) &#123;</span><br><span class="line">                $rule = $group . ($rule ? <span class="string">'/'</span> . ltrim($rule, <span class="string">'/'</span>) : <span class="string">''</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>::setOption($option);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'bind_model'</span>]) &amp;&amp; <span class="keyword">isset</span>($option[<span class="string">'bind_model'</span>])) &#123;</span><br><span class="line">                $option[<span class="string">'bind_model'</span>] = array_merge($options[<span class="string">'bind_model'</span>], $option[<span class="string">'bind_model'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            $result = <span class="keyword">self</span>::checkRule($rule, $route, $url, $pattern, $option, $depr);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span> !== $result) &#123;</span><br><span class="line">                <span class="keyword">return</span> $result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">//上面是检测分组路由的.没有就下来这边,没有自动解析地址,那就直接返回false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($auto)) &#123;</span><br><span class="line">        <span class="comment">// 自动解析URL地址</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::parseUrl($auto[<span class="string">'route'</span>] . <span class="string">'/'</span> . $url, $depr);</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($miss)) &#123;</span><br><span class="line">        <span class="comment">// 未匹配所有路由的路由规则处理</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::parseRule(<span class="string">''</span>, $miss[<span class="string">'route'</span>], $url, $miss[<span class="string">'option'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于传进来的当前请求方法路由状态数组进行遍历，如果当前路由的方法状态是true，那么获取到这个路由内容返回$item，然后拿着这些获取到的路由参数对局部变量进行赋值。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628182922476.png" alt="image-20200628182922476"></p>
<p>赋值完之后会检测这些参数的有效性，出现一个疑问不知道为什么普通路由是无法通过路由有效性的，会直接跳过当前方法循环。也就无法去到下面的代码分支。*<em>所以这个方法的作用为首先遍历路由规则，当遍历到普通路由，会跳出循环。遍历到分组路由的时候回进入953行的分支去检测分组路由，进入之后获取到分组路由的key，并且判断pathinfo 中如果不是以当前分组路由key 开头的话，就跳出循环，表示没有匹配上此分组路由。  *</em> 那么我们的请求的PATHINFO是 ‘ / ‘， 肯定是匹配不上分组路由的。直接去到下面的分支。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628185859212.png" alt="image-20200628185859212"></p>
<p>990行，自动解析是空的，默认没有，也没有设置不匹配所有路由的路由规则处理。返回false。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们回顾整个Route::checkRoute方法，其实是去匹配分组路由的一个动作，去分析每一个分组路由，然后与PATHINFO去匹配，匹配都不成功最后会去到自动解析和不匹配所有路由规则处理方法，但是默认这2个参数，$auto,$miss都是不存在的。所以最后返回false直接回到App::routeCheck方法</span><br></pre></td></tr></table></figure>

<p>到这里<strong>Route::check</strong>方法已经执行完毕。总结：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">整个check方法可以看到首先检测了缓存，检测路由绑定，默认都没有，然后检测静态路由，如果没有静态路由，就去Route::checkRoute方法，检测分组路由，分组路由也没有匹配成功的话，就返回false。表示没有匹配成功路由。整个check方法结束。</span><br></pre></td></tr></table></figure>

<h4 id="Route-parseUrl-path-depr-config-‘controller-auto-search’"><a href="#Route-parseUrl-path-depr-config-‘controller-auto-search’" class="headerlink" title="# Route::parseUrl($path, $depr, $config[‘controller_auto_search’])"></a># Route::parseUrl($path, $depr, $config[‘controller_auto_search’])</h4><p>回到App::routeCheck方法判断是否必须匹配路由才能完成请求，默认不是的，继续往下，经过上面的静态路由检测，分组路由检测，代表当前PATHINFO并没有匹配成功到路由，那么进行此解析URL方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">public static function parseUrl($url, $depr = '/', $autoSearch = false)   // $url 的形式  如果为空,默认为' / ' , 如果是模块,控制器,方法 admin/controller/action</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">self</span>::$bind[<span class="string">'module'</span>])) &#123;<span class="comment">//是否有绑定模块,有无做相关配置,当然是没有啦</span></span><br><span class="line">        $bind = str_replace(<span class="string">'/'</span>, $depr, <span class="keyword">self</span>::$bind[<span class="string">'module'</span>]);</span><br><span class="line">        <span class="comment">// 如果有模块/控制器绑定</span></span><br><span class="line">        $url = $bind . (<span class="string">'.'</span> != substr($bind, <span class="number">-1</span>) ? $depr : <span class="string">''</span>) . ltrim($url, $depr);</span><br><span class="line">    &#125;</span><br><span class="line">    $url              = str_replace($depr, <span class="string">'|'</span>, $url); <span class="comment">//再次把url中的斜杠/都换成竖线 |    当有指定路由的时候</span></span><br><span class="line">    <span class="keyword">list</span>($path, $var) = <span class="keyword">self</span>::parseUrlPath($url);<span class="comment">// 解析$path</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 这里 让$path = ['模块','控制器','操作'] 如果传进来的不是这种格式就直接让$path=[$path] 所以符合格式有3个值,不符合格式只有1个值,(空,或者模块名),其他为null</span></span><br><span class="line"><span class="comment">     *  $var 无论如何都是空的 不知道有什么用 后续也没有用到过.</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    $route            = [<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>]; <span class="comment">//定义路由</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($path)) &#123;</span><br><span class="line">        <span class="comment">// 解析模块</span></span><br><span class="line">        $module = Config::get(<span class="string">'app_multi_module'</span>) ? array_shift($path) : <span class="keyword">null</span>; <span class="comment">//默认支持多模块,然后把模块也就是$path第一个元素弹出给$module,这里$module是空的</span></span><br><span class="line">        <span class="keyword">if</span> ($autoSearch) &#123;<span class="comment">//   自动搜索默认是false</span></span><br><span class="line">            <span class="comment">// 自动搜索控制器</span></span><br><span class="line">            $dir    = APP_PATH . ($module ? $module . DS : <span class="string">''</span>) . Config::get(<span class="string">'url_controller_layer'</span>);</span><br><span class="line">            $suffix = App::$suffix || Config::get(<span class="string">'controller_suffix'</span>) ? ucfirst(Config::get(<span class="string">'url_controller_layer'</span>)) : <span class="string">''</span>;</span><br><span class="line">            $item   = [];</span><br><span class="line">            $find   = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">foreach</span> ($path <span class="keyword">as</span> $val) &#123;</span><br><span class="line">                $item[] = $val;</span><br><span class="line">                $file   = $dir . DS . str_replace(<span class="string">'.'</span>, DS, $val) . $suffix . EXT;</span><br><span class="line">                $file   = pathinfo($file, PATHINFO_DIRNAME) . DS . Loader::parseName(pathinfo($file, PATHINFO_FILENAME), <span class="number">1</span>) . EXT;</span><br><span class="line">                <span class="keyword">if</span> (is_file($file)) &#123;</span><br><span class="line">                    $find = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $dir .= DS . Loader::parseName($val);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($find) &#123;</span><br><span class="line">                $controller = implode(<span class="string">'.'</span>, $item);</span><br><span class="line">                $path       = array_slice($path, count($item));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $controller = array_shift($path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 解析控制器</span></span><br><span class="line">            $controller = !<span class="keyword">empty</span>($path) ? array_shift($path) : <span class="keyword">null</span>; <span class="comment">//取controller</span></span><br><span class="line">            <span class="comment">//上面又对这个值弹出,那么$path就是空的,是这种情况的话,那就是null</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析操作</span></span><br><span class="line">        $action = !<span class="keyword">empty</span>($path) ? array_shift($path) : <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 解析额外参数</span></span><br><span class="line">        <span class="keyword">self</span>::parseUrlParams(<span class="keyword">empty</span>($path) ? <span class="string">''</span> : implode(<span class="string">'|'</span>, $path));</span><br><span class="line">        <span class="comment">/*这里已经都将路由3要素都取出了,如果$path还有值,默认认定为参数,如果不是空的,将后面的值比如 module/controller/action/a/123</span></span><br><span class="line"><span class="comment">        那就变成  self::parseUrlParams('a|123'); 跟进.</span></span><br><span class="line"><span class="comment">        最后是将这个 a|123 解析成数组$var,找到原本的request对象,最后保存到Request对象的route成员变量里面了</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装路由</span></span><br><span class="line">        $route = [$module, $controller, $action];</span><br><span class="line">        <span class="comment">// 检查地址是否被定义过路由</span></span><br><span class="line">        $name  = strtolower($module . <span class="string">'/'</span> . Loader::parseName($controller, <span class="number">1</span>) . <span class="string">'/'</span> . $action);</span><br><span class="line">        <span class="comment">//  $name =  module/controller/action</span></span><br><span class="line"></span><br><span class="line">        $name2 = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($module) || <span class="keyword">isset</span>($bind) &amp;&amp; $module == $bind) &#123;<span class="comment">//如果没传入控制器的情况,$name2= controller/action</span></span><br><span class="line">            $name2 = strtolower(Loader::parseName($controller, <span class="number">1</span>) . <span class="string">'/'</span> . $action);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">self</span>::$rules[<span class="string">'name'</span>][$name]) || <span class="keyword">isset</span>(<span class="keyword">self</span>::$rules[<span class="string">'name'</span>][$name2])) &#123;</span><br><span class="line">            <span class="comment">//这里决定了如果定义了路由,只能通过路由key访问此 M/C/A, 而不能通过M/C/A这种默认格式来访问.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">'invalid request:'</span> . str_replace(<span class="string">'|'</span>, $depr, $url));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">'type'</span> =&gt; <span class="string">'module'</span>, <span class="string">'module'</span> =&gt; $route]; <span class="comment">//最后把M/C/A都存到$route 返回</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断是否有路由绑定，index.php是没有的，跳过。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628232902287.png" alt="image-20200628232902287"></p>
<p>去到1246行，获取$path和$var参数，这里$var永远都是空的，是获取不到参数的。因为这个方法是获取问号后面的值作为$var，但是问号后面的值一般不会传到PATHINFO里面。</p>
<h4 id="URL转换成路由调度信息的实现"><a href="#URL转换成路由调度信息的实现" class="headerlink" title="# URL转换成路由调度信息的实现"></a># URL转换成路由调度信息的实现</h4><p><strong>而这里的$path，就是$url(等于PATHINFO的值)以斜杠’ / ‘为分隔符打散成数组的。<em>$dispatch也就是这里来的，通过传入的PATHINFO，以斜杠 / 分隔符打散数组。</em></strong> </p>
<p> 回到parseUrl方法，初始化$route 路由信息。 $route = [null, null ,null] ，接着1252行，判断$path是否有获取到，进入分支。解析获取模块，$module为空字符串，没有自动搜索控制器配置，直接跳到1280行分支。获取控制器$controller为null，同样获取到操作也为null。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$module = <span class="string">''</span> ; $controller = <span class="keyword">null</span> ; $action = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>下面1286，判断$path是否还有参数，这里已经都将路由3要素都取出了,如果$path还有值,默认认定为参数,如果不是空的,将后面的值比如 module/controller/action/a/123<br>那就变成  self::parseUrlParams(‘a|123’); 跟进.最后是将这个 a|123 解析成数组$var,找到原本的request对象,最后保存到Request对象的route成员变量里面了。</p>
<p>接着封装路由，最后把这个$route返回。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628195225979.png" alt="image-20200628195225979"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">parseUrl方法总结：首先通过对pathinfo的格式进行解析，通过对斜杠的分割成数组，获得数组$route&#x3D;[&#39;模块&#39;,&#39;控制器&#39;,&#39;方法&#39;] ，并且最后返回。 </span><br><span class="line">return [&#39;type&#39; &#x3D;&gt; &#39;module&#39;, &#39;module&#39; &#x3D;&gt; $route];</span><br></pre></td></tr></table></figure>

<p>再次回到App::routeCheck()，这里将返回的东西赋值给$result并返回给run()方法的$dispatch，回到run()方法，至此已经完成了路由信息检测。最后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">App::routeCheck 小结：</span><br><span class="line">最后$dispatch &#x3D; [&#39;type&#39; &#x3D; &#39;module&#39;, &#39;module&#39; &#x3D; [模块，控制器，方法]]，是通过通过传入PATHINFO，以斜杠 &#x2F; 分隔符打散数组而赋值给$path,然后$path在集成到$dispatch里面。这就是路由生成的方法</span><br></pre></td></tr></table></figure>



<p>继续<strong>run方法</strong>往下走，128行开始：将调度信息同步到$request-&gt;dispatch变量中。</p>
<p>记录路由和请求信息，这里重点关注执行了<strong>$request-&gt;param</strong>方法，<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628200657244.png" alt="image-20200628200657244"></p>
<p>这里没有调用方法时传入参数，默认获取所有参数值，这个方法最终是通过助手函数的Input 去获取了客户端传入的参数，input函数会用过滤器对数据进行过滤，但是本套程序默认没有设置过滤器。</p>
<p>继续往下，关键位置 <strong>$data = self::exec($dispatch, $config);</strong></p>
<h3 id="0x05-exec"><a href="#0x05-exec" class="headerlink" title="# 0x05 exec"></a># 0x05 exec</h3><p>整套框架组成最重要的几个部分可以概括为：</p>
<p>1、路由检测分析</p>
<p>2、初始化调用模块、控制器、方法</p>
<p>3、根据方法返回的数据渲染前端界面进行输出到客户端</p>
<p>exec方法即为第二部分，初始化路由3要素，并最后执行方法，然后返回数据。跟进。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628201606591.png" alt="image-20200628201606591"></p>
<p>从上面返回数据得知，$dispatch的第一个元素，type是module，进入module分支，然后执行<strong>module方法</strong> ，执行完module方法，$data返回，并且把$data返回给run方法。那么其实exec就是执行module方法，执行完把数据返回而已。下面跟进module。</p>
<h4 id="module-三要素数组，-config，null"><a href="#module-三要素数组，-config，null" class="headerlink" title="# module(三要素数组，$config，null)"></a># module(三要素数组，$config，null)</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">public static function module($result, $config, $convert = null) //$result = 三要素</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_string($result)) &#123;</span><br><span class="line">        $result = explode(<span class="string">'/'</span>, $result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $request = Request::instance(); <span class="comment">//实例化request对象,带到这个执行模块的方法中来</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($config[<span class="string">'app_multi_module'</span>]) &#123;</span><br><span class="line">        <span class="comment">// 多模块部署 默认true</span></span><br><span class="line">        $module    = strip_tags(strtolower($result[<span class="number">0</span>] ?: $config[<span class="string">'default_module'</span>])); <span class="comment">//这里判断模块是不是空的,如果是空就用默认配置的模块..这就是空path,获取到默认模块的处理位置</span></span><br><span class="line">        $bind      = Route::getBind(<span class="string">'module'</span>); <span class="comment">//没有路由绑定  路由绑定? 参考admin.php 是定义了个常量做路由绑定,然后在run里面就bind上了这个模块</span></span><br><span class="line">        $available = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($bind) &#123;</span><br><span class="line">            <span class="comment">// 绑定模块</span></span><br><span class="line">            <span class="keyword">list</span>($bindModule) = explode(<span class="string">'/'</span>, $bind);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($result[<span class="number">0</span>])) &#123;</span><br><span class="line">                $module    = $bindModule;</span><br><span class="line">                $available = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> ($module == $bindModule) &#123;</span><br><span class="line">                $available = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (!in_array($module, $config[<span class="string">'deny_module_list'</span>]) &amp;&amp; is_dir(APP_PATH . $module)) &#123;<span class="comment">//判断这个模块不在黑名单模块中,而且也存在这个模块文件夹,就赋值标识为可以访问</span></span><br><span class="line">            $available = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模块初始化  :  加载对应模块下的配置文件到$config中,补充进来</span></span><br><span class="line">        <span class="keyword">if</span> ($module &amp;&amp; $available) &#123;<span class="comment">//有模块了,而且可用了,进行初始化模块</span></span><br><span class="line">            <span class="comment">// 初始化模块</span></span><br><span class="line">            $request-&gt;module($module); <span class="comment">// 给request对象的成员变量 赋值 当前模块名</span></span><br><span class="line">            $config = <span class="keyword">self</span>::init($module);</span><br><span class="line">            <span class="comment">//1. 加载公共文件    2.加载模块配置并且返回获取前面所有加载的配置.并返回给$config  包括: 数据库配置 // 模块配置(如果有) // 扩展目录下面的所有配置 // 应用状态配置 //行为扩展文件 //  语言包</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 模块请求缓存检查</span></span><br><span class="line">            $request-&gt;cache(</span><br><span class="line">                $config[<span class="string">'request_cache'</span>],</span><br><span class="line">                $config[<span class="string">'request_cache_expire'</span>],</span><br><span class="line">                $config[<span class="string">'request_cache_except'</span>]</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">'module not exists:'</span> . $module);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 单一模块部署</span></span><br><span class="line">        $module = <span class="string">''</span>;</span><br><span class="line">        $request-&gt;module($module);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认过滤机制</span></span><br><span class="line">    $request-&gt;filter($config[<span class="string">'default_filter'</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前模块路径</span></span><br><span class="line">    App::$modulePath = APP_PATH . ($module ? $module . DS : <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否自动转换控制器和操作名</span></span><br><span class="line">    $convert = is_bool($convert) ? $convert : $config[<span class="string">'url_convert'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取控制器名</span></span><br><span class="line">    $controller = strip_tags($result[<span class="number">1</span>] ?: $config[<span class="string">'default_controller'</span>]);<span class="comment">//从$result传入的路由调度信息中获取控制器名,如果没有就用$config中配置的默认的控制器,赋值给$controller</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/^[A-Za-z](\w|\.)*$/'</span>, $controller)) &#123;<span class="comment">//判断控制器的格式,有误404</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">'controller not exists:'</span> . $controller);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $controller = $convert ? strtolower($controller) : $controller; <span class="comment">//将控制器名小写</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取操作名</span></span><br><span class="line">    $actionName = strip_tags($result[<span class="number">2</span>] ?: $config[<span class="string">'default_action'</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($config[<span class="string">'action_convert'</span>])) &#123;</span><br><span class="line">        $actionName = Loader::parseName($actionName, <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $actionName = $convert ? strtolower($actionName) : $actionName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置当前请求的控制器、操作</span></span><br><span class="line">    $request-&gt;controller(Loader::parseName($controller, <span class="number">1</span>))-&gt;action($actionName);<span class="comment">//赋值request对象的 控制器名和方法名.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听module_init</span></span><br><span class="line">    Hook::listen(<span class="string">'module_init'</span>, $request);</span><br><span class="line">    <span class="comment">//   上面一堆找模块文件夹,拿控制器名和命名空间,拿方法名 , 然后对request对象进行赋值等表面操作都做完后,接下来开始执行加载控制器</span></span><br><span class="line">    <span class="keyword">try</span> &#123;<span class="comment">//加载控制器 ----------------------------------------------------------------大头</span></span><br><span class="line">        $instance = Loader::controller(</span><br><span class="line">            $controller, <span class="comment">// 控制器index</span></span><br><span class="line">            $config[<span class="string">'url_controller_layer'</span>], <span class="comment">// 默认的访问控制器层 controller</span></span><br><span class="line">            $config[<span class="string">'controller_suffix'</span>], <span class="comment">// 控制器类后缀 false</span></span><br><span class="line">            $config[<span class="string">'empty_controller'</span>] <span class="comment">//默认的空控制器名 Error</span></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 控制器类操作,利用依赖注入的方式实例化了控制器类, 最后把对象返回给了$instance</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException $e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">'controller not exists:'</span> . $e-&gt;getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前操作名</span></span><br><span class="line">    $action = $actionName . $config[<span class="string">'action_suffix'</span>];<span class="comment">//获取到index</span></span><br><span class="line"></span><br><span class="line">    $vars = [];</span><br><span class="line">    <span class="keyword">if</span> (is_callable([$instance, $action])) &#123; <span class="comment">//判断当前控制器有当前方法</span></span><br><span class="line">        <span class="comment">// 执行操作方法</span></span><br><span class="line">        $call = [$instance, $action];<span class="comment">//$call = [实例化后的控制器对象, 方法名]</span></span><br><span class="line">        <span class="comment">// 严格获取当前操作方法名</span></span><br><span class="line">        $reflect    = <span class="keyword">new</span> \ReflectionMethod($instance, $action);<span class="comment">//根据对象,方法名,获取到方法反射对象.</span></span><br><span class="line">        $methodName = $reflect-&gt;getName();<span class="comment">//获取方法名字</span></span><br><span class="line">        $suffix     = $config[<span class="string">'action_suffix'</span>];<span class="comment">//获取方法名前缀</span></span><br><span class="line">        $actionName = $suffix ? substr($methodName, <span class="number">0</span>, -strlen($suffix)) : $methodName;<span class="comment">//有前缀的话,去掉前缀,没前缀直接方法名赋值给$actionName</span></span><br><span class="line">        $request-&gt;action($actionName); <span class="comment">// 把方法名赋值到 request-&gt;action 中.</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">elseif</span> (is_callable([$instance, <span class="string">'_empty'</span>])) &#123;<span class="comment">//如果控制器没有当前方法,空操作,看下控制器有没有_empty方法,然后让$vars等于这个空操作方法名</span></span><br><span class="line">        <span class="comment">// 空操作</span></span><br><span class="line">        $call = [$instance, <span class="string">'_empty'</span>];</span><br><span class="line">        $vars = [$actionName];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 操作不存在</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">'method not exists:'</span> . get_class($instance) . <span class="string">'-&gt;'</span> . $action . <span class="string">'()'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Hook::listen(<span class="string">'action_begin'</span>, $call);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>::invokeMethod($call, $vars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开始判断$result，也就是$route，路由调度信息是否为字符串，这里是数组。跳过。</p>
<p>540行判断是否为多模块部署，默认是true，进入分支，首先获取module，判断result[0]是否有元素，有元素的话就获取这个元素为模块（这里为空字符串’’，空字符串是false）,没有就用配置中的<strong>$config[‘default_module’]</strong>，这就是默认模块的来源，这里因为是空字符串，是false，所以获取到的是 <strong>默认模块也就是index</strong> 。接着没有路由绑定，初始化<strong>$available = false;</strong>  因为模块没有绑定路由，获取到$bind = null ，接着去到556行，判断这个模块不在黑名单模块中,而且也存在这个模块文件夹,就赋值标识为可以访问，然后<strong>$available = true;</strong>  </p>
<p>561行，当可访问状态和模块都获取成功了，下面开始初始化模块。先给request对象同步模块名信息，然后根据当前模块获取模块配置，<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628204530248.png" alt="image-20200628204530248"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628204633351.png" alt="image-20200628204633351"></p>
<p>index模块下只有config.php，直接去到266行进行加载。加载之后，<strong>$config会多出index/config.php</strong>的配置，同时<strong>Config::$config[$range] [‘配置名’]也会把新配置merge进去方便之后调用</strong>。是后面前端模板渲染，以及模板替换字符串的定义配置。接着读取模块数据库文件配置，这里模块下没有数据库配置文件，所以为空，下面的配置加载也无效。接着尝试加载各种模块对应的配置文件如<strong>公共文件，行为扩展文件</strong>，index模块都没有，直接跳过，最后返回处执行Config::get()方法。获取所有配置并且返回给<strong>module方法的$config</strong> <img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628205324038.png" alt="image-20200628205324038"></p>
<p>回到module()方法的564行，<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628205818185.png" alt="image-20200628205818185"></p>
<p>此时有self::init返回获取到的$config，是额外添加了模块配置的$config,把当前module的自定义的配置额外都添加了进来。所以是包含了特定module配置的config，便于后面使用。</p>
<p>一路下来到592，因为路由三要素后面2个元素都是null，获取控制器这里获取到了<strong>默认控制器为Index</strong>，然后将控制器名转化为小写index</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628210024703.png" alt="image-20200628210024703"></p>
<p>最后获取<strong>方法名</strong>同样是<strong>获取默认的index</strong> </p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200628210745595.png" alt="image-20200628210745595"></p>
<p>一路来到关键的614行。加载控制器操作。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200629072523287.png" alt="image-20200629072523287"></p>
<h3 id="0x06-Loader-controller-加载控制器"><a href="#0x06-Loader-controller-加载控制器" class="headerlink" title="# 0x06 Loader::controller() 加载控制器"></a># 0x06 Loader::controller() 加载控制器</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$instance = Loader::controller(</span><br><span class="line">$controller, <span class="comment">// 控制器index</span></span><br><span class="line">$config[<span class="string">'url_controller_layer'</span>], <span class="comment">// 默认的访问控制器层 controller</span></span><br><span class="line">$config[<span class="string">'controller_suffix'</span>], <span class="comment">// 控制器类后缀 false</span></span><br><span class="line">$config[<span class="string">'empty_controller'</span>] <span class="comment">//默认的空控制器名 Error</span></span><br><span class="line">        );</span><br></pre></td></tr></table></figure>

<p>跟进。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200629073206357.png" alt="image-20200629073206357"></p>
<p>先获取<strong>模块$module和控制器Index类的命名空间$class</strong>，判断控制器类$class是否存在，然后执行<strong>App::invokeClass($class)</strong> </p>
<h4 id="App-invokeClass-class"><a href="#App-invokeClass-class" class="headerlink" title="# App::invokeClass($class)"></a># App::invokeClass($class)</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200629074029478.png" alt="image-20200629074029478"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * 第一步 new一个 反射类对象  这个对象有类的所有方法,类属性,类名等.$reflect</span><br><span class="line"> * 第二步 利用这个反射类对象 获取 类的构造函数, $constructor</span><br><span class="line"> * 第三步 bindParams 传入的是 构造函数的反射对象 以及需要绑定 变量, 这里传入反射获得的构造函数对象,然后需要绑定的变量,这个变量是$_GET传的,键值对形式.</span><br><span class="line"> * 然后通过 getParamValue 去绑定 每个参数 最后返回一个数组就是这个 $args ,里面存着这个构造函数需要的参数,按顺序的.</span><br><span class="line"> * 第四步 利用刚刚按顺序绑定出来的数组$args 去执行这个 反射类的 实例化,传入参数数组$args给他的 __constructor 构造函数</span><br><span class="line"> * *&#x2F;</span><br></pre></td></tr></table></figure>

<p>分析bind::Params($constructor,$vars)方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bindParams</span><span class="params">($reflect, $vars = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 自动获取请求变量</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($vars)) &#123;</span><br><span class="line">        $vars = Config::get(<span class="string">'url_param_type'</span>) ? <span class="comment">//这里判断url参数类型,是按成对读取还是按顺序读取.默认是0,按名称成对读取 a=1</span></span><br><span class="line">        Request::instance()-&gt;route() :</span><br><span class="line">        Request::instance()-&gt;param();<span class="comment">//走param方法.进去跟进 最终让$vars = ['a' = 1]  参数值是过滤过的</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $args = [];</span><br><span class="line">    <span class="keyword">if</span> ($reflect-&gt;getNumberOfParameters() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 判断数组类型 数字数组时按顺序绑定参数       //如果这个类的参数,也就是构造函数的参数大于0个,</span></span><br><span class="line">        reset($vars); <span class="comment">//把指针移到数组的第一位</span></span><br><span class="line">        $type = key($vars) === <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;<span class="comment">//判断当前指针位置的键名 是不是等于0 如果等于0 说明 数组是普通数组,不等于0 说明是关联数组,这个代表了前端传入参数的类型,用于后续的绑定参数</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($reflect-&gt;getParameters() <span class="keyword">as</span> $param) &#123;  <span class="comment">//首先,遍历的每一个反射参数,都是构造函数中按顺序进入的,进入之后.</span></span><br><span class="line">            $args[] = <span class="keyword">self</span>::getParamValue($param, $vars, $type);<span class="comment">//往里面新增参数</span></span><br><span class="line">        &#125;  <span class="comment">//面对每个执行此方法的反射参数,首先判断是否是 对象 参数,如果是,尝试实例化,并且赋值给result并返回,因为参数 按顺序进入  参数 又按顺序返回,这样就构成了参数与返回参数值,以及最后调用的对应关系</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着去到387行，实例化这个控制器类。跟进Index类构造函数。发现Index没有构造函数，而Index类继承HomeBase类，HomeBase也没有constructor,但继承Controller，执行Controller的构造函数。</p>
<p>进入构造函数<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200629080225875.png" alt="image-20200629080225875"></p>
<p>第66行是初始化视图类，传入template是模板渲染引擎，后面是预设的替换字符串。这一部分配置主要获取来源是模块配置，模块目录下的config.php<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200629080412900.png" alt="image-20200629080412900"></p>
<p>convention.php里面这2个配置是空的。去到View类的初始化方法：         <img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200629090715451.png" alt="image-20200629090715451"></p>
<h4 id="View-对象初始化"><a href="#View-对象初始化" class="headerlink" title="# View 对象初始化"></a># View 对象初始化<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200629091722571.png" alt="image-20200629091722571"></h4><p>把引擎数组<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200629092049596.png" alt="image-20200629092049596"></p>
<p>传入engine方法。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200629092114490.png" alt="image-20200629092114490"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* 1.$options传入数组,默认引擎参数没有type  使用默认的Think引擎.</span><br><span class="line"> * 2.首先判断引擎参数有无type,有type的话使用type作为引擎,没有用Think</span><br><span class="line"> * 3.规范引擎类的格式,前面加上\think\view\driver\  用于代表引擎类</span><br><span class="line"> * 4.最后new一个引擎类的对象出来,new $class 然后复制给当前类的对象 的engine参数,返回整个View对象</span><br><span class="line"> * 总结:通过引擎参数,分析使用哪个模板解析引擎,然后new一个引擎对象,赋值给自身对象的engine成员变量,并将自身对象返回.</span><br><span class="line"> * *&#x2F;</span><br></pre></td></tr></table></figure>

<p>回到View构造函数， <img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630134830720.png" alt="image-20200630134830720"></p>
<p>先获取请求request对象。接着获取基础根目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$base    = $request-&gt;root();</span><br></pre></td></tr></table></figure>

<p>获取到$root的项目根目录，用于后面替换字符串的时候拼接使用。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630135441042.png" alt="image-20200630135441042"></p>
<p>最后将这些需要替换的字符串保存到对象变量View-&gt;replace中，后续模板渲染的时候使用。回到控制器的构造函数。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630135730907.png" alt="image-20200630135730907"></p>
<p>获取request对象。然后执行控制器<strong>Index类的_initialize初始化函数</strong> ：</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630135822874.png" alt="image-20200630135822874"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630140038911.png" alt="image-20200630140038911"></p>
<p>先调用父类也就是Homebase的初始化函数，<strong>这一个初始化函数是从数据库取获取站点的系统信息以及登录信息的，也就是说，当实例化任意一个控制器的时候，控制器类的构造函数会自动执行控制器对象，Index（这个请求是Index控制器）的_initialize()方法，而又继承的是HomBase，会自动去执行HOMEBASE的初始化方法，可以认为是当访问站点主页或子页等这种控制器时，会去确认站点信息以及系统登录情况，通过去数据库中查询相关信息，并将相关信息assign到模板里面，保存到 <em>模板变量</em> 替换的数组中。View-&gt;data数组。</strong></p>
<p>看到有2个关键方法：<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630140046838.png" alt="image-20200630140046838"></p>
<p>进行跟进。</p>
<h4 id="HomeBase-getSystem"><a href="#HomeBase-getSystem" class="headerlink" title="# HomeBase   :  getSystem()"></a># HomeBase   :  getSystem()</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630192732391.png" alt="image-20200630192732391"></p>
<p>先判断是否有缓存，如果没有缓存会进入数据库中查询site_config，最后再设置缓存，这个程序默认是文件缓存类型，File.php，写缓存，缓存文件名是MD5的<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630193422816.png" alt="image-20200630193422816"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630193503384.png" alt="image-20200630193503384"></p>
<p>缓存部分不深究，回到getSystem，可以看到<strong>最后是把获取到的$site_config这个数组，同步到了View-&gt;data这个数组里面，给后面模板变量替换使用的。</strong></p>
<h4 id="HomeBase-systemlogin"><a href="#HomeBase-systemlogin" class="headerlink" title="#  HomeBase   :  systemlogin()"></a>#  HomeBase   :  systemlogin()</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630193925234.png" alt="image-20200630193925234"></p>
<p>这个函数后续会出现在登录部分的逻辑中，是会出现漏洞的，这里对此方法进行详细步骤跟进，判断账户是否登录。</p>
<p>首先通过助手函数session去读取对应的session，跟进session助手函数。</p>
<h5 id="session助手函数全过程。"><a href="#session助手函数全过程。" class="headerlink" title="# session助手函数全过程。"></a># session助手函数全过程。</h5><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630194451195.png" alt="image-20200630194451195" style="zoom:80%;">

<p>传入参数$name = userid，另外两个为空，直接跳到308行，判断$name的值，然后执行Session::get($name,$prefix)，这里prefix为null，跟进。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630194735260.png" alt="image-20200630194735260"></p>
<p>164行开始初始化session，根据配置文件中的session数组配置进行一通设置，接着给$prefix赋值那个5位随机大小写字母的前缀。因为传入了$name,判断获取单独的session还是获取全部session，跳到171行获取userid的session。  然后赋值 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$value = <span class="keyword">isset</span>($_SESSION[$prefix][$name]) ? $_SESSION[$prefix][$name] : <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>但是因为访问没有$_SESSION所以最终返回null。</p>
<p><strong>session小结：可以看到session助手函数获取session是直接通过$_SESSION[$prefix] [session名]直接获取的。</strong></p>
<h4 id="回到systemlogin"><a href="#回到systemlogin" class="headerlink" title="# 回到systemlogin"></a># 回到systemlogin</h4><p>上面没有获取到userid的session，所以进入if分支，去到51行，<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630200104086.png" alt="image-20200630200104086"></p>
<p>这里通过cookie助手函数去获取sys_key的cookie，这个助手函数跟session相似不进行跟进，也是通过$_COOKIE[$key]的方法直接获取并没有做其他处理，<strong>然后对cookie值进行解密。</strong></p>
<h4 id="sys-key-的-cookie-解密函数-decrypt-加密encrypt-以及登录逻辑"><a href="#sys-key-的-cookie-解密函数-decrypt-加密encrypt-以及登录逻辑" class="headerlink" title="# sys_key 的 cookie 解密函数 decrypt() ,加密encrypt(),以及登录逻辑"></a># sys_key 的 cookie 解密函数 decrypt() ,加密encrypt(),以及登录逻辑</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630200356618.png" alt="image-20200630200356618"></p>
<p>这个解密cookie的函数，后续会与登录成功功能的加密user用户名的加密函数对应的，通过加解密这个参数来校验用户名user。下面是登录功能设置sys_key的代码。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630200905227.png" alt="image-20200630200905227"></p>
<p>systemSetKey 此函数就是设置sys_key的方法。</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630200936063.png" alt="image-20200630200936063"></p>
<p>开始分析上面的解密函数：$txt为sys_key的cookie，$key和$ttl都为空。当然这里我的请求包也是没有sys_key 的，等于说3个参数都是空的。会直接返回空，但是为了跟进，我们静态查看下面的解密过程。</p>
<p>107行可以看到密钥$key的存在，可以看到如果没有传入密钥的话会去数据库取盐再md5，作为密钥。<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630201707319.png" alt="image-20200630201707319"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200630202306082.png" alt="image-20200630202306082"></p>
<p>这段代码是对密钥$key的每一个字符，按顺序转换成ascii值，并且全部相加，变成$knum。</p>
<p><strong>我输入我的cookie  KakDRsys_key = 111 为例  即 $txt = 111，举例看下解密过程。</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">    $ch1 = @$txt&#123;$knum % $tlen&#125;;<span class="comment">//经过上面计算，$knum=2176,$tlen=3，最终为$txt&#123;1&#125;=1（等于$txt的第二个字符）; </span></span><br><span class="line"><span class="comment">// @ $ch1 由 knum 计算而来</span></span><br><span class="line">    $nh1 = strpos($chars, $ch1);<span class="comment">//在$chars字符集中找到$ch1的位置. 本例为 $nh1=53;</span></span><br><span class="line">    $txt = @substr_replace($txt, <span class="string">''</span>, $knum % $tlen--, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//$txt = 11  @注意删除的位数跟$ch1的关系</span></span><br><span class="line">    $ch2 = @$txt&#123;$nh1 % $tlen&#125;;<span class="comment">//$nh1 % $tlen = 1 $txt=11</span></span><br><span class="line"><span class="comment">// $ch2 = 1 ; @ch2 由 nh1 计算出来</span></span><br><span class="line">    $nh2 = @strpos($chars, $ch2); <span class="comment">// 找到ch2在字符集的位置,nh2 = 53</span></span><br><span class="line">    $txt = @substr_replace($txt, <span class="string">''</span>, $nh1 % $tlen--, <span class="number">1</span>);<span class="comment">//$txt =  1  @注意删除的位数跟ch2的关系</span></span><br><span class="line">    $ch3 = @$txt&#123;$nh2 % $tlen&#125;;<span class="comment">// @ch3 由 nh2 计算而来    ch3 = 1 </span></span><br><span class="line">    $nh3 = @strpos($chars, $ch3); <span class="comment">// 继续寻找 nh3 = 53</span></span><br><span class="line">    $txt = @substr_replace($txt, <span class="string">''</span>, $nh2 % $tlen--, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//对1求余,等于0, $txt = '' 空字符串.tlen = 0</span></span><br><span class="line">    $nhnum = $nh1 + $nh2 + $nh3; <span class="comment">// nhnum= 53+53+53 = 159</span></span><br><span class="line">    $mdKey = substr(md5(md5(md5($key . $ch1) . $ch2 . $ikey) . $ch3), $nhnum % <span class="number">8</span>, $knum % <span class="number">8</span> + <span class="number">16</span>);</span><br><span class="line"><span class="comment">// md5(md5(md5(key+ch1)+ch2+ikey)+ch3) 再截取从 nhum%8 开始的 长度为  knum%8+16.  结果为mdKey</span></span><br><span class="line">    $tmp = <span class="string">''</span>;</span><br><span class="line">    $j = <span class="number">0</span>;</span><br><span class="line">    $k = <span class="number">0</span>;</span><br><span class="line">    $tlen = @strlen($txt);</span><br><span class="line">    $klen = @strlen($mdKey);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $tlen; $i++) &#123;</span><br><span class="line">        $k = $k == $klen ? <span class="number">0</span> : $k;</span><br><span class="line">        $j = strpos($chars, $txt&#123;$i&#125;) - $nhnum - ord($mdKey&#123;$k++&#125;);</span><br><span class="line">        <span class="keyword">while</span> ($j &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            $j += <span class="number">64</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $tmp .= $chars&#123;$j&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    $tmp = str_replace(<span class="keyword">array</span>(<span class="string">'-'</span>, <span class="string">'_'</span>, <span class="string">'.'</span>), <span class="keyword">array</span>(<span class="string">'+'</span>, <span class="string">'/'</span>, <span class="string">'='</span>), $tmp);</span><br><span class="line">    $tmp = trim(base64_decode($tmp));</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/\d&#123;10&#125;_/s"</span>, substr($tmp, <span class="number">0</span>, <span class="number">11</span>))) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($ttl &gt; <span class="number">0</span> &amp;&amp; (time() - substr($tmp, <span class="number">0</span>, <span class="number">11</span>) &gt; $ttl)) &#123;</span><br><span class="line">            $tmp = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $tmp = substr($tmp, <span class="number">11</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这段分析到$mdKey就看不懂了..俗话说解铃还须系铃人,解密函数看不懂,先去看看加密函数怎么回事.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701001955196.png" alt="image-20200701001955196"></p>
<p>调用加密函数的位置在<strong>application/user/controller/Login.php</strong> 的</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701064734782.png" alt="image-20200701064734782"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701064746898.png" alt="image-20200701064746898"></p>
<p>这里是登录的位置,可以看到85行判断密码登录成功后对cookie进行的操作.登录逻辑未完待续@@@@@@@@将会在另一篇文章专门分析登录逻辑.</p>
<h4 id="回到systemlogin-1"><a href="#回到systemlogin-1" class="headerlink" title="# 回到systemlogin"></a># 回到systemlogin</h4><p>判断session中没有userid也就是没有登录的话,会尝试去获取cookie中的sys_key,如果仍然没有获取到,表示没有登录,结束.如果上面判断用户已经登录已经获得userid,则会对当前userid 的<strong>$_session</strong>设置 $user的数组,<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701065540738.png" alt="image-20200701065540738"></p>
<p><strong>因为sys_key是一个数组序列化后,再加密形成的,上面对其进行解密,再进行反序列化得到$user就是一个user信息数组.</strong> 所以这里从cookie获得了$user数组要同步到SESSION里面去.并且更新数据库中相关用户的登录时间和ip信息.</p>
<h4 id="回到-initialize"><a href="#回到-initialize" class="headerlink" title="# 回到_initialize"></a># 回到_initialize</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701065759216.png" alt="image-20200701065759216"></p>
<p>24,25,26都是先去读取缓存文件,如果没有则去数据库读取对应的内容最后再设置缓存,获取的是导航栏的信息.其实<strong>导航栏内容就是一个数组.</strong>保存了一些title信息<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701070017470.png" alt="image-20200701070017470"></p>
<p>这面<strong>nav_cms1,nav_cms2</strong>在数据库中都是有数据的,以至于我调试的时候对会去读取缓存文件(因为我调试肯定是第二次访问了,此前第一次访问的时候已经做了缓存了),唯独<strong>nav_cms0</strong>是每次都会去数据库尝试读取内容,也借此了解了整个数据库查询的逻辑.</p>
<h3 id="0x07-通过getNav-nav-cms-0-获取nav-cms0-–跟进DB查询逻辑和实现"><a href="#0x07-通过getNav-nav-cms-0-获取nav-cms0-–跟进DB查询逻辑和实现" class="headerlink" title="# 0x07 通过getNav(nav_cms,0),  获取nav_cms0 –跟进DB查询逻辑和实现"></a># 0x07 通过getNav(nav_cms,0),  获取nav_cms0 –跟进DB查询逻辑和实现</h3><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701070633616.png" alt="image-20200701070633616"></p>
<p>直接进入到166行,new一个NavModel(), <img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701070731926.png" alt="image-20200701070731926"></p>
<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701070753358.png" alt="image-20200701070753358" style="zoom:50%;">

<p><strong>理解模型的时候我去数据库看了一些数据表,发现一个模型有些会对应一个数据表,模型里面会定义一些特定针对此表的 <em>方法或者变量</em> ,方便使用,相当于一个数据表模型</strong></p>
<p>上面跟进类的构造函数来到他的父类Model __construct函数.没有传入参数,直接来到153行获取到类名<strong>app\common\model\NavCms</strong> ,接着初始化模型名</p>
<p><code>$this-&gt;name = NavCms</code> </p>
<p>最后跟进下来这个构造函数也只是获取了NavCms-&gt;name的值为NavCms,其他的也没做什么操作.回到getNav方法.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701072024735.png" alt="image-20200701072024735"></p>
<p>下面这里不知道为什么又要去new多一个模型对象才去执行这个<strong>catetree2($pid)</strong> 为什么不用上面new出来的对象呢,先不管.new这个NavModel的过程上面已经分析完毕,我们直接去到cate方法.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701072245236.png" alt="image-20200701072245236"></p>
<p>分析Db::name方法.发现Db是没有name方法的,<strong>当调用一个类不存在的静态方法时,会调用其所在类__callStatic方法.</strong></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701072406655.png" alt="image-20200701072406655"></p>
<p><strong>而我们Db操作都是链式操作,Db类中压根没几个静态方法,当我们只要调用Db类静态方法的时候,就会先来执行这个函数.<em>使用静态方式调用动态类中的动态方法，即让类无需实例化而直接进行静态方式的调用，带来了更好的可测试性和扩展性。</em></strong></p>
<h4 id="Db-callStatic函数的用处是什么呢"><a href="#Db-callStatic函数的用处是什么呢" class="headerlink" title="# Db::__callStatic函数的用处是什么呢?"></a># Db::__callStatic函数的用处是什么呢?</h4><p>我们刚刚调用的Db静态方法是name,参数是nav_cms,那么这里的参数<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701072836600.png" alt="image-20200701072836600"></p>
<p>177行开始先执行connect函数,参数为方法名name,跟进.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701073509961.png" alt="image-20200701073509961"></p>
<p>执行的是self::connect() 参数都为空,由后面的101行<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701074221059.png" alt="image-20200701074221059"></p>
<p><strong>可以看到当数据库连接被初始化之后,就会根据不同的连接配置$config存在Db::instance中,防止重复初始化,所以是以不同的配置来区分连接的.</strong></p>
<p>这里我们进来是空的,所以$name = md5(空值),就以当前配置进行初始化了.进入81行分支,<em>(这里其实不是第一次来初始化这个数据库连接了,会直接跳到return,我们为了分析,尝试进入分支.)</em></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$field = <span class="string">'$pid = 0'</span>  ;</span><br><span class="line">$param = [<span class="number">0</span>] = <span class="string">'pid=0'</span>;</span><br></pre></td></tr></table></figure>

<p>把条件字段获取过来到$param中, 然后把字段弹出.跟进parseWhereExp</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701112013093.png" alt="image-20200701112013093"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701112109503.png" alt="image-20200701112109503"></p>
<p>前面把field从$param弹出应该是因为传入参数的时候也会传$field,所以把field—第一个参数弹出.进入方法.判断$field字段是不是匿名函数,显然不是.跳过分支.来到1288行,判断         Query-&gt;options数组,是否有via元素,显然是没有的,这边刚进来参数是空的,<strong>后续这个Query-&gt;options是用来存sql语句查询参数的</strong>. 1292行判断$field 是否是表达式的实例,跳过.去到1301行,然后对$where 数组进行添加元素, </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$where[] = [<span class="string">'exp'</span>, <span class="keyword">$this</span>-&gt;raw($field)];</span><br></pre></td></tr></table></figure>

<p>这个分支其实是判断了$field是一个字符串的表达式 ,那下面where数组就存一个exp元素,对应字段的字符串.这个raw方法是将$field ,  拿去实例化Expression对象,也就是简单的将表达式放到对象参数里面了.简单初始化.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701195652738.png" alt="image-20200701195652738"></p>
<p><strong>那么这时候$where 已经存了 [‘exp’,$field对应的Expression对象了]</strong></p>
<p>继续往下,判断$op 默认为null,跳过, 直接跳出分支到1344行,判断$where是否已经赋值,然后判断如果<strong>$this-&gt;options[‘where’] [‘AND’] 没有设置的话,那就初始化为空数组.</strong> 然后执行checkMultiField方法,判断没有多字段,返回直接去到最后关键步骤.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701201422214.png" alt="image-20200701201422214"></p>
<p>也就是说,在调用parseWhereExp,解析where表达式方法执行完,</p>
<p><strong>最终都是在Query对象把上面 获得的   $where = [‘exp’,’解析到的Expression对象’],这个数组,合并到数组 $this-&gt;options[‘where’] [‘AND’] = [[‘exp’,’解析到的Expression对象’]] 里面,  这个options[‘where’]表示where表达式,后面的AND表示 表达符号 ,数组元素 也是数组 ,为[‘exp’,’Expression对象,他的value存了条件如$pid=0’]</strong>  </p>
<p><strong><em>最终生成的表达式为 where $pid = 0 AND $this-&gt;options[‘where’] [‘AND’]数组里别的元素</em></strong></p>
<h4 id="回到where方法"><a href="#回到where方法" class="headerlink" title="# 回到where方法"></a># 回到where方法</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701202339564.png" alt="image-20200701202339564"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">where方法小结:将传入的条件字符串 转换成数组 [&#39;exp&#39;,&#39;条件字符串的Expression对象&#39;]</span><br><span class="line">赋值到Query-&gt;options[&#39;where&#39;][&#39;AND&#39;]里面.效果如下图.最后赋值完将Query对象返回.</span><br><span class="line">可以看到Query查询对象用于存储查询参数以及解析参数的.</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701202957086.png" alt="image-20200701202957086"></p>
<h4 id="order-方法"><a href="#order-方法" class="headerlink" title="# order 方法"></a># order 方法<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701203124076.png" alt="image-20200701203124076"></h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701203134480.png" alt="image-20200701203134480"></p>
<p>同样跟where方法很像,去到1575行,因为传入的只有 $field = id ASC ,1575行判断传入的方式,有无逗号将排序模式与列数隔开,这里是没有隔开的,直接$field = id ASC一起传入,$order=Null,那么让$field 直接等于 $field .  <img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701203457103.png" alt="image-20200701203457103"></p>
<p>最后直接让options 的 order元素下 添加$field,效果如图,最终返回query对象.又保存了一个查询参数.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701203555585.png" alt="image-20200701203555585"></p>
<h4 id="select-函数"><a href="#select-函数" class="headerlink" title="# select()函数"></a># select()函数</h4><p>接下来去到Query的select()函数,前两个分支都不会进入,<strong>因为调用方式无参数.只是select()..</strong><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701203715668.png" alt="image-20200701203715668"></p>
<p>去到2491,<strong>parseExpress()</strong>方法.这个方法的作用是将比如之前我们的name()函数,去设置访问的数据表的时候,结果只是给Query-&gt;name变量进行了赋值,这里就需要通过这个方法来将这些相关的要用到的参数 <strong>全部都同步到当前方法的局部变量$options数组里面,并且将Query-&gt;options这个对象的数组unset清空.</strong><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701204314057.png" alt="image-20200701204314057"></p>
<p>执行完结果如图.下面还有很多参数没截到.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701204205913.png" alt="image-20200701204205913"></p>
<p>继续select方法,去到2501行开始,<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701204432603.png" alt="image-20200701204432603"></p>
<p>2511行,去找到构造器 builder对象,专门生成MYSQL查询语句的一个对象.执行他的select方法去生成select语句.跟进.传入$options 参数数组.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701204813035.png" alt="image-20200701204813035"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $selectSql    = <span class="string">'SELECT%DISTINCT% %FIELD% FROM %TABLE%%FORCE%%JOIN%%WHERE%%GROUP%%HAVING%%UNION%%ORDER%%LIMIT%%LOCK%%COMMENT%'</span>;</span><br></pre></td></tr></table></figure>

<p><strong>可以看到,此方法作用就是将从$selectSql里面找到上面这些字符串,然后用$options里面的对应的参数替换掉,最后返回替换掉的语句,就是完整的SQL语句了.</strong></p>
<p>跟进其中一个解析参数的方法看看做了什么操作:<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701205014226.png" alt="image-20200701205014226"></p>
<p>对表名的首尾加了反引号 变为 `ls_nav_cms` . 等执行完所有解析参数之后,生成sql为<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701205539345.png" alt="image-20200701205539345"></p>
<p>这就完成sql语句的构造了.回到select().</p>
<p>跟进到2523,执行查询操作<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701205730332.png" alt="image-20200701205730332"></p>
<p>跟进query函数.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701205757209.png" alt="image-20200701205757209"></p>
<p>又去到连接对象的查询.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701205820578.png" alt="image-20200701205820578"></p>
<p>initConnect没做任何操作,应该是分布式数据库的初始化.这里没有.下面记录查询语句Connection-&gt;queryStr = $sql. 无参数绑定.后面怎么查询就不深究了,反正就是去查询并且返回结果集.回到select方法.因为数据库是没数据的,返回结果集是空的,<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701210930923.png" alt="image-20200701210930923"></p>
<p>2531的缓存自然也没有用<strong>最后返回了个空集给$tptc</strong> <img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701211038415.png" alt="image-20200701211038415"></p>
<h4 id="回到-initialize函数"><a href="#回到-initialize函数" class="headerlink" title="# 回到_initialize函数,"></a># 回到_initialize函数,<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701212251727.png" alt="image-20200701212251727"></h4><p>查询无果,$cmsnav0 为空. <img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701222634464.png" alt="image-20200701222634464"></p>
<p>下面的话重点跟进下assign函数,29行,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;assign(<span class="string">'cmsnav'</span>, $cmsnav);</span><br></pre></td></tr></table></figure>

<p>跟进.去到View-&gt;assign方法,<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701222835992.png" alt="image-20200701222835992"></p>
<p><strong>简单来说,就是让View-&gt;data[‘模板变量名’] = 模板变量值….最终View-&gt;data[‘cmsnav’] = $cmsnav</strong>. 返回View对象.</p>
<p>下面的初始化操作都是大同小异,就不跟进了.最后执行完之后,回到Index控制器类,<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701223252540.png" alt="image-20200701223252540"></p>
<p>获取站点配置.再次回到控制器的构造函数.无前置操作方法,结束.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701223324523.png" alt="image-20200701223324523"></p>
<p>整个<strong>Index控制器</strong>的初始化也结束了.</p>
<h3 id="0x08-action-方法-Index"><a href="#0x08-action-方法-Index" class="headerlink" title="# 0x08  action 方法 Index"></a># 0x08  action 方法 Index</h3><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701223550743.png" alt="image-20200701223550743"></p>
<p>首先获取操作方法名.为$action = index ; 上面初始化控制器的时候返回了一个$instance 控制器对象了,这里拿来使用,判断这个控制器中,$action是否可调用 ; 进入分支,利用反射, 获取到 <strong>$reflect,代表的是$action方法的反射对象</strong> ; 再通过这个方法的反射对象拿到方法名<strong>$methodName</strong> ; 从配置中获取方法名前缀(默认为空) ;   把方法名同步到requst对象的action变量中, request-&gt;action ; 最后!<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701224125410.png" alt="image-20200701224125410"></p>
<p><strong>invoke去调用此方法并传入$vars参数.</strong> invokeMethod.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701224245149.png" alt="image-20200701224245149"></p>
<p>先获取类到<strong>$class,</strong>再获取Index的反射方法对象到<strong>$reflect</strong> ,然后去获取 action的参数. 跟进执行<strong>App::bindParams</strong>.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>::bindParams($reflect, $vars)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701230203545.png" alt="image-20200701230203545"></p>
<p>首先判断获取参数的方式,默认以 <strong>?key=value</strong>  获取. 配置中的值是0,</p>
<p><strong>那么走request-&gt;param()方法.</strong></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701231315116.png" alt="image-20200701231315116"></p>
<p>这里是通过$_GET $_POST等根据不同的请求获取到原始的数据,<strong>接着用input助手函数去处理进行危险字段过滤(默认没有filter)</strong> 这边的param()方法没有传入参数,指的是获取所有参数,对<strong>request-&gt;param</strong>直接进行input过滤获取出来.这个变量是之前这里就已经执行过此方法,$this-&gt;param已经合并了get参数值了,所以这里直接取出即可.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701232405954.png" alt="image-20200701232405954"></p>
<p>下面初始化参数列表.判断反射方法参数个数. 大于0进入分支.index方法没有参数,直接跳过..我们假设有参数的情况下,进去分析下是什么逻辑.首先对拿到的$vars指针移到第一位.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701232726247.png" alt="image-20200701232726247"></p>
<p>然后判断当前$vars数组指针处的键名,如果不是0,也就是说如果不是普通数组,而是关联数组,比如当前情况,key为’a’,那么置$type 为 0 ,表明获取参数类型.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701232753746.png" alt="image-20200701232753746"></p>
<p>遍历每一个反射参数 然后 执行<strong>getParamValue($param, $vars, $type)</strong></p>
<p>跟进分析.type为0,直接去到454行 上面获取了$name 是当前参数名<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701233402942.png" alt="image-20200701233402942"></p>
<p>如果当发现,$vars参数里面,有当前参数名相关的key 也就是$vars[$name]存在的情况下,就将<strong>$vars[$name]的值</strong>  赋值给$result,然后返回.然后添加到<strong>$args[]</strong>中,对每一个反射参数都进行如此操作,<strong>按顺序添加到$args[]中即可.</strong></p>
<p>回到invodeMethod<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701234105894.png" alt="image-20200701234105894">调用反射方法的invokeArgs,第一个参数为调用此方法的对象,也就是当前控制器对象$instance. 在方法开头获取的349行.</p>
<p>接下来执行方法啦!</p>
<p>来到index方法.开始业务代码.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701234426944.png" alt="image-20200701234426944"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701234436907.png" alt="image-20200701234436907"></p>
<p>业务代码不分析了,可以看到都是从数据库中查询东西并且assign到View对象里面用作前端模板变量替换用.最后的<strong>return view();</strong> 重点跟进下.</p>
<h4 id="return-view"><a href="#return-view" class="headerlink" title="# return view()"></a># return view()</h4><p>数据操作获取完,assign完模板变量,开始渲染模板输出.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200701234830797.png" alt="image-20200701234830797"></p>
<h3 id="0x09-Response类"><a href="#0x09-Response类" class="headerlink" title="# 0x09 Response类"></a># 0x09 Response类</h3><p><strong>执行Response::create($template,’view’,$code)</strong> 来到Response类的create方法.传入<strong>view作为输出类型</strong>  $template为输出的数据.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702220753998.png" alt="image-20200702220753998"></p>
<p>因为上面助手函数所有参数都是空值,create的$template也为空,其他都为空,首先获取<strong>\think\response\view</strong> 类,然后初始化此类.返回对象.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702221106171.png" alt="image-20200702221106171"></p>
<p>初始化resp/view, <strong>这个view对象跟之前的think/view对象是不同的,那个view对象已经保存了之前assign进去的参数数组了.</strong> 执行的构造函数是 <strong>Response-&gt;__construct</strong>作为多种resp子类(View,json,jsonp,Rediret,xml),在初始化子类时都执行父类resp的构造方法,针对传入的数据,返回码,header,输出参数参数,<strong>都是同步给对象的成员变量.初始化的对象变量.</strong></p>
<p>初始化完Response/View 对象之后,返回当前对象,然后接着链式操作执行</p>
<h4 id="Response-View-gt-replace方法-进行视图内容的替换"><a href="#Response-View-gt-replace方法-进行视图内容的替换" class="headerlink" title="# Response/View-&gt;replace方法.进行视图内容的替换"></a># Response/View-&gt;replace方法.进行视图内容的替换</h4><p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702222054006.png" alt="image-20200702222054006"></p>
<p>传入的也都是空参数,直接返回对象.如果有需要视图内容替换的会将传入的参数同步到$this-&gt;replcae数组里面.</p>
<p>继续去到assign函数,模板变量赋值.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702222152999.png" alt="image-20200702222152999"></p>
<p>同样,如果有传入模板变量赋值会将传入的变量数组同步到Response/View-&gt;vars数组里面去. <strong>此请求在以上2个函数都没做任何操作,没有视图内容和模板变量需要赋值.</strong>返回Response/View对象. </p>
<p><strong>*<u>至此,已经执行完整个module方法.也就是说模块,控制器,操作,我们都已经执行完了.并且返回了Response/View对象.作为执行完方法的数据.接下来要去到前端渲染界面处理</u>*</strong>.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702222831658.png" alt="image-20200702222831658"></p>
<p><strong><u><em>exec方法也执行完毕,将 Resp/View对象返回<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702223057289.png" alt="image-20200702223057289"></em></u></strong></p>
<p><strong>下面将返回Response/View对象赋值给$response最后返回此对象.</strong></p>
<h3 id="0x0B-send"><a href="#0x0B-send" class="headerlink" title="# 0x0B send()"></a># 0x0B send()</h3><p>App::run()方法执行完,最终返回了一个Response/View对象,然后跟进执行他的send()方法:<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702223518194.png" alt="image-20200702223518194"></p>
<p>Hook函数这里不深究,当listen了某一个tag,会去执行这个tag注册的Hook类的run函数.钩子函数.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702223708418.png" alt="image-20200702223708418"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702223733181.png" alt="image-20200702223733181"></p>
<p>回到send()方法.关键方法 getContent()<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702235449155.png" alt="image-20200702235449155"></p>
<p>跟进:</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200702235516250.png" alt="image-20200702235516250"></p>
<p>前面是没有对content做赋值的,为null,进入下面output方法.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703001624877.png" alt="image-20200703001624877"></p>
<p>获取到<strong>think\View,大View对象再去执行它的fetch函数..</strong>,里面有保存所有前面assign到的模板变量数组.Response\View相反是什么都没有的.然后执行大View的fetch函数.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703002401846.png" alt="image-20200703002401846"></p>
<p>关键步骤.<strong>fetch函数用于解析和获取模板内容</strong></p>
<h4 id="think-View的fetch"><a href="#think-View的fetch" class="headerlink" title="# think/View的fetch()"></a># think/View的fetch()</h4><p>传入参数都是空值,首先将各种数组merge进来,那么$this-&gt;data是保存了之前的模板变量的,其他两个都为空,那么直接$vars里面就有值了.<strong>开启缓冲区</strong>.参照网上资料</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.防止在浏览器有输出之后再使用setcookie，或者header，session_start函数造成的错误。（我本以为最开始说的代码是这样的作用，但后来朋友说不是的），其实这样的用法少用为好，养成良好的代码习惯。</span><br><span class="line">2.捕捉对一些不可获取的函数的输出，比如phpinfo会输出一大堆的HTML，但是我们无法用一个变量例如$info&#x3D;phpinfo();来捕捉，这时候ob就管用了</span><br><span class="line">3.对输出的内容进行处理，例如进行gzip压缩，例如进行简繁转换，例如进行一些字符串替换。</span><br><span class="line">4.生成静态文件，其实就是捕捉整页的输出，然后存成文件，经常在生成HTML，或者整页缓存中使用。</span><br></pre></td></tr></table></figure>

<p>根据上面资料,发现主要是<strong>针对第四点来使用ob_start()</strong> </p>
<p>渲染输出.获取到 <strong>渲染方法 $method 为 fetch</strong></p>
<p>接着对<strong>自定义模板的字符串替换</strong>的数组赋值给$replace , 同步替换字符串过来.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703115751642.png" alt="image-20200703115751642"></p>
<p>对此<strong>引擎对象执行config方法</strong><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703160158484.png" alt="image-20200703160158484"></p>
<p>将上面获得的<strong>替换字符串$replace</strong>传入,config,从config函数能看到<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703162455874.png" alt="image-20200703162455874"></p>
<p>分支跳转去到166行执行.$this-&gt;template.这是模板引擎对象.  think/Template类,然后去设置赋值他的$name属性,$name = ‘tpl_replace_string’.看了下模板对象不存在此属性变量,而且对象具有__set方法,那么自动执行__set()方法,<strong>(当设置不存在的属性时,执行__set方法)</strong><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703161431906.png" alt="image-20200703161431906"></p>
<p>结果就是给自身的config数组赋值 $this-&gt;config[‘tpl_replace_string’] = 替换字符串数组.接着回来是给 <strong>think/view/driver/Think</strong> <strong>模板引擎对象的config也同步替换字符串</strong></p>
<p>此时也就是<strong>think/Template对象</strong> ,  <strong>think/view/driver/Think</strong>对象都同步了替换字符串到他们各自的config数组里面.</p>
<p>最后执行引擎对象的fetch方法.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703162057163.png" alt="image-20200703162057163"></p>
<p>跟进.</p>
<h3 id="0x0C-渲染模板文件-模板引擎对象-think-view-driver-Think-的fetch"><a href="#0x0C-渲染模板文件-模板引擎对象-think-view-driver-Think-的fetch" class="headerlink" title="# 0x0C 渲染模板文件.模板引擎对象 think/view/driver/Think 的fetch()"></a># 0x0C 渲染模板文件.模板引擎对象 think/view/driver/Think 的fetch()</h3><h3 id="-2"><a href="#-2" class="headerlink" title></a><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703162106412.png" alt="image-20200703162106412"></h3><p>根据传入的$template模板文件,判断后缀名,如果没有后缀名,跟进下面去获取模板文件名.$template为空的.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703164020119.png" alt="image-20200703164020119"></p>
<p>开始是判断插件是否存在,跳过.去到130行,获取到$path为模板配置中的值 <img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703164359514.png" alt="image-20200703164359514"></p>
<p>[TOC]</p>
<p>然后对路径进行补全,获取控制器名,组成文件名,为 <strong>控制器_方法名</strong>.</p>
<p>最终拼接返回 模板文件目录 : 最后添加上html后缀.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703164542400.png" alt="image-20200703164542400"></p>
<p>返回值 $template为<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703164640535.png" alt="image-20200703164640535"></p>
<p><strong>小结:上面的方法可以看到是没有传入模板文件$template 最终组成模板文件名是以    控制器_方法名.html 返回的.如果设置了$template, 会直接以这个作为文件名.拼接上前面的$path组成完整的模板文件路径.  而且,<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703164946285.png" alt="image-20200703164946285"></strong></p>
<p><strong>这一步骤指的是 如果模板名$template 中有@  比如 module@template这样的格式,会获取到$module = module ,然后这是一种多模块调用模式,就去获取到这个特定模块的view模板目录,如果没有module,就获取config配置中的默认 view_path路径作为模板路径.</strong></p>
<p>回到fetch方法.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703165250076.png" alt="image-20200703165250076"></p>
<p>判断当前模板文件是否存在.然后下面执行 </p>
<p><strong>think/Template 对象</strong>的fetch方法,传入当前模板文件,vars也是从 think/View 对象传过来的,包含了View对象里面所有的模板变量替换数据的.config倒是空的.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703165504166.png" alt="image-20200703165504166"></p>
<p>首先将模板变量$vars同步到当前对象的<strong>data数组</strong>中.去到168行,读取渲染缓存.</p>
<p>然而这里cache_id为空,而且 display_cache也为false,所以不读取缓存.</p>
<p><strong>$this-&gt;parseTemplateFile( $template)</strong> 跟进:传入文件名.其实就是更新了下模板文件更新的时间.<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703170251917.png" alt="image-20200703170251917"></p>
<p>接着回到177行,</p>
<p><code>$cacheFile = $this-&gt;config[&#39;cache_path&#39;] . $this-&gt;config[&#39;cache_prefix&#39;] . md5($this-&gt;config[&#39;layout_name&#39;] . $template) . &#39;.&#39; . ltrim($this-&gt;config[&#39;cache_suffix&#39;], &#39;.&#39;);</code></p>
<p>定义赋值缓存文件为$cacheFile .这个缓存文件<strong>唯一识别字段是对$template的md5值</strong> ,所以这里得到缓存文件路径之后判断缓存是否存在.不存在的话就对它重新进行模板编译.这里是存在的,但是为了跟进编译的过程.我们尝试进入此分支.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703175014972.png" alt="image-20200703175014972"></p>
<p>首先将html模板文件的内容读取过来到$content,然后将内容和缓存文件名,传入$this-&gt;compiler函数.跟进.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703175528212.png" alt="image-20200703175528212"></p>
<p>默认不开启布局,直接进入337行.看到将html内容传入此函数,<img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703180100475.png" alt="image-20200703180100475"></p>
<p><strong>此方法就是通过正则,去匹配HTML模板文件中的各种预设好的字符串然后替换掉,最后生成一个PHP缓存文件保存起来,之后的调用同一个控制器_方法 都会用同一个缓存php文件.  这个过程就是编译,将html文件将里面的变量进行替换最终变成可执行的php文件,然后上面的步骤写入缓存文件.接下来就会访问这个缓存的php文件</strong></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703181321522.png" alt="image-20200703181321522"></p>
<p>回到fetch方法: 189行.执行文件渲染对象 <strong>File的read方法</strong></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703181359939.png" alt="image-20200703181359939"></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703181430477.png" alt="image-20200703181430477"></p>
<p>先同步缓存文件路径,前面fetch方法将View的模板变量数组同步到$this-&gt;data里面的$vars,然后上面又传入的$vars到read,这里就是讲<strong>模板变量数组 注册成变量.第二个参数表示如果某个变量已经存在,用数组中的值覆盖变量</strong>,最后把当前php 包含进来,等于执行此php文件了. 将输出的东西全部获取到$content中.最后输出echo  $content. <strong>这里是不会输出内容的,开启了页面缓存,暂时放在了缓冲区里面,避免后面发送header报错.</strong></p>
<p><strong><u><em>上面fetch方法已经成功编译了模板文件,替换了模板变量字符串,生成了用于输出的php文件并且将输出内容获取到到了$content.继续getContent()方法.</em></u></strong></p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703183621752.png" alt="image-20200703183621752"></p>
<p>获得了$content之后将它同步给Resp\View对象的content属性中. 并且返回此属性给$data.回到send方法.</p>
<p><img src="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20200703183949241.png" alt="image-20200703183949241"></p>
<p>这里我们看到是先发送头部信息,再echo $data,为什么这么做?之前的页面都开启了 <strong>ob_start()</strong>,将获取到的东西都通过 <strong>ob_get_content() 获取到$content里面,然后返回给$data</strong>,这么做是<strong>防止在输出header前面就把内容输出了会报错,所以通过这种缓冲区的方法先将内容保存起来,等到回到这里的时候先把header输出,再echo  $data 整个生命周期就完成了.</strong></p>
<p>后面对Session进行清空.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="# 总结"></a># 总结</h3><p>至此,请求<a href="http://phplearning:9001/index.php?a=1&amp;b=2" target="_blank" rel="noopener">http://phplearning:9001/index.php?a=1&amp;b=2</a> 的整个执行流程就走完了,本文写的很乱,仅仅是为了记录下自己跟进的整个过程方便以后回看,后续会对此cms已经爆出过的漏洞进行分析学习,从之前不知道整个框架做了什么到知道这个请求如何一步一步输出到浏览器中,这个学习的过程让我受益匪浅,继续努力~</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Dj3ntG0d</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://dj3ntg0d.github.io/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://dj3ntg0d.github.io/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/php-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">php,代码审计</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/"><img class="prev_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Laysns注册登录逻辑分析及任意用户登录--注册篇</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Dj3ntG0d</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script></body></html>