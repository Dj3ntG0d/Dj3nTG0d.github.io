<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Laysns注册登录逻辑分析及任意用户登录--注册篇 | Dj3ntG0d's Blog</title><meta name="description" content="# 0x00 前言上集说到systemlogin()这个方法里面有对cookie反序列化的动作,也发现是在Login登录界面对这个cookie:(5位随机字母+sys_key) 进行加密赋值的,加上此前看到有师傅分析过用户登录过程也存在伪造任意用户登录的问题,此篇继续对整个流程: 注册 -&gt; 登录 流程进行分析跟进.顺便也将上篇博客分析到一半的加解密函数 encrypt和decrypt 这2"><meta name="author" content="Dj3ntG0d"><meta name="copyright" content="Dj3ntG0d"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Laysns注册登录逻辑分析及任意用户登录--注册篇"><meta name="twitter:description" content="# 0x00 前言上集说到systemlogin()这个方法里面有对cookie反序列化的动作,也发现是在Login登录界面对这个cookie:(5位随机字母+sys_key) 进行加密赋值的,加上此前看到有师傅分析过用户登录过程也存在伪造任意用户登录的问题,此篇继续对整个流程: 注册 -&gt; 登录 流程进行分析跟进.顺便也将上篇博客分析到一半的加解密函数 encrypt和decrypt 这2"><meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Laysns注册登录逻辑分析及任意用户登录--注册篇"><meta property="og:url" content="https://dj3ntg0d.github.io/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/"><meta property="og:site_name" content="Dj3ntG0d's Blog"><meta property="og:description" content="# 0x00 前言上集说到systemlogin()这个方法里面有对cookie反序列化的动作,也发现是在Login登录界面对这个cookie:(5位随机字母+sys_key) 进行加密赋值的,加上此前看到有师傅分析过用户登录过程也存在伪造任意用户登录的问题,此篇继续对整个流程: 注册 -&gt; 登录 流程进行分析跟进.顺便也将上篇博客分析到一半的加解密函数 encrypt和decrypt 这2"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2020-07-05T07:08:57.000Z"><meta property="article:modified_time" content="2020-07-05T13:59:52.986Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://dj3ntg0d.github.io/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/"><link rel="prev" title="Laysns注册登录逻辑分析及任意用户登录--登录和漏洞篇" href="https://dj3ntg0d.github.io/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95-%E7%99%BB%E5%BD%95%E5%92%8C%E6%BC%8F%E6%B4%9E%E7%AF%87/"><link rel="next" title="Thinkphp5框架实现以及生命周期源码分析" href="https://dj3ntg0d.github.io/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">3</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text"># 0x00 前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-注册流程"><span class="toc-number">2.</span> <span class="toc-text"># 0x01 注册流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#访问注册页面"><span class="toc-number">2.1.</span> <span class="toc-text"># 访问注册页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#输入参数进行注册"><span class="toc-number">2.2.</span> <span class="toc-text"># 输入参数进行注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Request-gt-post"><span class="toc-number">2.3.</span> <span class="toc-text"># Request-&gt;post()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Request-gt-input"><span class="toc-number">2.4.</span> <span class="toc-text">#Request-&gt;input()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Request-gt-getFilter"><span class="toc-number">2.4.1.</span> <span class="toc-text"># Request-&gt;getFilter()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回到input"><span class="toc-number">2.5.</span> <span class="toc-text"># 回到input()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Request-gt-filterValue"><span class="toc-number">2.5.1.</span> <span class="toc-text"># Request-&gt;filterValue()</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Request-gt-filterExp-amp-value"><span class="toc-number">2.5.1.1.</span> <span class="toc-text"># Request-&gt;filterExp(&amp;$value)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#回到filterValue"><span class="toc-number">2.5.2.</span> <span class="toc-text"># 回到filterValue</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回到input-1"><span class="toc-number">2.6.</span> <span class="toc-text"># 回到input()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回到-reg"><span class="toc-number">3.</span> <span class="toc-text"># 回到 reg()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#model-User-gt-allowField-gt-save"><span class="toc-number">3.1.</span> <span class="toc-text"># model\User-&gt;allowField()-&gt;save()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-End-总结"><span class="toc-number">4.</span> <span class="toc-text"># The End 总结</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Dj3ntG0d's Blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Laysns注册登录逻辑分析及任意用户登录--注册篇</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-07-05 15:08:57"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-07-05</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-07-05 21:59:52"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-07-05</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="# 0x00 前言"></a># 0x00 前言</h3><p>上集说到<strong>systemlogin()</strong>这个方法里面有对cookie反序列化的动作,也发现是在Login登录界面对这个<strong>cookie:(5位随机字母+sys_key)</strong> 进行加密赋值的,加上此前看到有师傅分析过用户登录过程也存在伪造任意用户登录的问题,此篇继续对整个流程: <strong><u><em>注册 -&gt; 登录</em></u></strong> 流程进行分析跟进.顺便也将上篇博客分析到一半的加解密函数 <strong>encrypt和decrypt</strong> 这2个方法进行补全.</p>
<h3 id="0x01-注册流程"><a href="#0x01-注册流程" class="headerlink" title="# 0x01 注册流程"></a># 0x01 注册流程</h3><h4 id="访问注册页面"><a href="#访问注册页面" class="headerlink" title="# 访问注册页面"></a># 访问注册页面</h4><p>在页面访问注册界面,查看url :  <a href="http://localhost:9001/index.php/reging.html" target="_blank" rel="noopener">http://localhost:9001/index.php/reging.html</a> 明显是通过路由访问的方法,找到路由条目,</p>
<p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705152027860.png" alt="image-20200705152027860"></p>
<p>跟进到相关控制器.</p>
<p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705154446328.png" alt="image-20200705154446328"></p>
<p>首先让 <strong>$_SESSION[5位随机字母] [‘callbackurl’] = ‘index.php’.</strong> 设置回调URL,后面应该会用到.<strong>5位随机字母是session的前缀,在安装的时候生成的,放到session配置文件中.</strong></p>
<p>接着判断此session中没有userid,也就是说当前SESSION会话应该是没有登录才可以进行注册的.</p>
<p>131行从缓存中获取站点信息,是一个包含了站点标题,名称等相关信息的<strong>数组</strong>.</p>
<p>接着实例化了一个User模型,保存了一些主键信息,插入字段等.初始化的过程中,通过这个Model类的名字获取了此模型对应的模型名,存到app\common\model\User -&gt;name 中, 为User,其他操作都不重要.继续往下.</p>
<p>141行,判断请求方法是POST还是GET,当我们第一次访问注册页面,直接通过输入URL的方式,为GET,直接去到return view()渲染输出.</p>
<h4 id="输入参数进行注册"><a href="#输入参数进行注册" class="headerlink" title="# 输入参数进行注册"></a># 输入参数进行注册</h4><p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705161304877.png" alt="image-20200705161304877"></p>
<p>随意填些信息.开启动态调试加抓包.</p>
<p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705161515401.png" alt="image-20200705161515401"></p>
<p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705161524676.png" alt="image-20200705161524676"></p>
<p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705161353332.png" alt="image-20200705161353332"></p>
<p>查看立即注册按钮的HTML和JS代码,看到是通过js POST发包给同样的reg方法,去到动态调试.</p>
<p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705162231700.png" alt="image-20200705162231700"></p>
<p>先判断站点是否开了注册功能,默认当然是开着的,然后去到下面获取<strong>POST参数信息,重点跟进下.</strong></p>
<h4 id="Request-gt-post"><a href="#Request-gt-post" class="headerlink" title="# Request-&gt;post()"></a># Request-&gt;post()</h4><p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705162310757.png" alt="image-20200705162310757"></p>
<p>这个post方法位于request请求对象中,参数会在执行这个方法之前就存到此对象的$this-&gt;post属性中了,这边是通过<strong>input</strong>方法将$this-&gt;post这个数组中的参数返回.继续跟进<strong>input方法.</strong></p>
<h4 id="Request-gt-input"><a href="#Request-gt-input" class="headerlink" title="#Request-&gt;input()"></a>#Request-&gt;input()</h4><p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705163135543.png" alt="image-20200705163135543"></p>
<p>这边传入的$name是没有字段名的,表示获取所有post参数的值,会直接去到1037行,解析过滤器.这套程序过滤器默认是空值,我们跟进getFilter.</p>
<h5 id="Request-gt-getFilter"><a href="#Request-gt-getFilter" class="headerlink" title="# Request-&gt;getFilter()"></a># Request-&gt;getFilter()</h5><p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705163553393.png" alt="image-20200705163553393"></p>
<p>默认没有全局过滤规则,最后返回了<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705163654269.png" alt="image-20200705163654269"></p>
<h4 id="回到input"><a href="#回到input" class="headerlink" title="# 回到input()"></a># 回到input()</h4><p>1039行,判断数据源如果是数组,然后对数组中的每个元素执行$this-&gt;filterValue方法,并且传入额外的$filter过滤器参数.</p>
<h5 id="Request-gt-filterValue"><a href="#Request-gt-filterValue" class="headerlink" title="# Request-&gt;filterValue()"></a># Request-&gt;filterValue()</h5><p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705164150926.png" alt="image-20200705164150926"></p>
<p>将post参数数组传入,获取默认过滤器(为空).</p>
<p>然后对剩下的 用户自定义过滤器方法数组遍历,</p>
<p>如果当前过滤器可以调用,<strong>就对元素值进行传入调用,返回过滤后的参数值回来.</strong> </p>
<p>如果不能调用,判断当前参数值是否为标量,如果是标量则进入过滤.上面分支是过滤器是个方法的时候,直接调用方法过滤,而下面这边则是判断,$filter中有 ‘/‘出现,则判断是正则表达式过滤,对$value进行匹配,匹配不成功返回默认值.</p>
<p>如果以上两种情况都不符合,即 $filter 既不是方法可以直接调用,也不是正则表达式,又有值的话,就判断它是利用了 <strong>PHP核心的过滤器</strong>,<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705165455711.png" alt="image-20200705165455711"></p>
<p>是官方预设的一些过滤器,通过<strong><u><em>filter_var()</em></u></strong> 方法来对这些过滤器进行调用过滤字符串,如果还是过滤不成功,返回false,跳出循环,最后执行<strong>filterExp方法.</strong></p>
<h6 id="Request-gt-filterExp-amp-value"><a href="#Request-gt-filterExp-amp-value" class="headerlink" title="# Request-&gt;filterExp(&amp;$value)"></a># Request-&gt;filterExp(&amp;$value)</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filterExp</span><span class="params">(&amp;$value)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 过滤查询特殊字符</span></span><br><span class="line">    <span class="keyword">if</span> (is_string($value) &amp;&amp; preg_match(<span class="string">'/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT LIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOT EXISTS|NOTEXISTS|EXISTS|NOT NULL|NOTNULL|NULL|BETWEEN TIME|NOT BETWEEN TIME|NOTBETWEEN TIME|NOTIN|NOT IN|IN)$/i'</span>, $value)) &#123;</span><br><span class="line">        $value .= <span class="string">' '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO 其他安全过滤</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法的作用是 <strong>如果变量值的字符串 等于 这些字符中 如’EXP’</strong></p>
<p>*<u>注意到 ^  和 $  ,只有参数值直接等于上面的字符才会匹配,但是这里为什么匹配成功后是将参数值拼接多一个空格?而不是直接置空或者其他操作?这样能起到过滤作用吗?</u>*</p>
<p>全部执行完返回后,回到filterValue().</p>
<h5 id="回到filterValue"><a href="#回到filterValue" class="headerlink" title="# 回到filterValue"></a># 回到filterValue</h5><p>继续对所有的参数都用同样的过滤器去处理,直到所有参数都过滤完毕.</p>
<h4 id="回到input-1"><a href="#回到input-1" class="headerlink" title="# 回到input()"></a># 回到input()</h4><p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705170521822.png" alt="image-20200705170521822"></p>
<p>1041行开始,当前$data已经全部过滤完毕,将指针放到$data的第一个键上,最后返回$data.</p>
<p><strong><u><em>总结: input() 所做的事情仅仅是将传过来的参数数组,然后用设定好的filter 对所有参数值进行了一次过滤,然后返回.</em></u></strong></p>
<p>返回之后,post()方法也返回,回到注册函数位置.</p>
<h3 id="回到-reg"><a href="#回到-reg" class="headerlink" title="# 回到 reg()"></a># 回到 reg()</h3><p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705170811654.png" alt="image-20200705170811654"></p>
<p>让<strong>$arr</strong> 获取了一个数组,里面的字符串是用户名黑名单,禁止用户注册这些用户名.</p>
<p>接着也是通过input方法,过滤的获得了$password.下面164行会执行很多验证器去验证数据合法性,略过,当合法性通过,继续else分支.<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705173918979.png" alt="image-20200705173918979"></p>
<p>170行.调用<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705174803032.png" alt></p>
<p>生成18位随机字符,组成$data [‘salt’] 的盐值.<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705175009495.png" alt="image-20200705175009495"></p>
<p>回到173行看到有个方法,<strong>remove_xss</strong>,跟进看看.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remove_xss</span><span class="params">($html)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $html = htmlspecialchars_decode($html);</span><br><span class="line">    preg_match_all(<span class="string">"/\&lt;([^\&lt;]+)\&gt;/is"</span>, $html, $ms);</span><br><span class="line"></span><br><span class="line">    $searchs[]  = <span class="string">'&lt;'</span>;</span><br><span class="line">    $replaces[] = <span class="string">'&amp;lt;'</span>;</span><br><span class="line">    $searchs[]  = <span class="string">'&gt;'</span>;</span><br><span class="line">    $replaces[] = <span class="string">'&amp;gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($ms[<span class="number">1</span>]) &#123;</span><br><span class="line">        $allowtags = <span class="string">'videoext|iframe|video|attach|img|a|font|div|table|tbody|caption|tr|td|th|br|p|b|strong|i|u|em|span|ol|ul|li|blockquote|strike|pre|code|embed'</span>;</span><br><span class="line">        $ms[<span class="number">1</span>]     = array_unique($ms[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">foreach</span> ($ms[<span class="number">1</span>] <span class="keyword">as</span> $value) &#123;</span><br><span class="line">            $searchs[] = <span class="string">"&amp;lt;"</span> . $value . <span class="string">"&amp;gt;"</span>;</span><br><span class="line"></span><br><span class="line">            $value = str_replace(<span class="string">'&amp;amp;'</span>, <span class="string">'_uch_tmp_str_'</span>, $value);</span><br><span class="line">            $value = string_htmlspecialchars($value);</span><br><span class="line">            $value = str_replace(<span class="string">'_uch_tmp_str_'</span>, <span class="string">'&amp;amp;'</span>, $value);</span><br><span class="line"></span><br><span class="line">            $value    = str_replace(<span class="keyword">array</span>(<span class="string">'\\'</span>, <span class="string">'/*'</span>), <span class="keyword">array</span>(<span class="string">'.'</span>, <span class="string">'/.'</span>), $value);</span><br><span class="line">            $skipkeys = <span class="keyword">array</span>(<span class="string">'onabort'</span>, <span class="string">'onactivate'</span>, <span class="string">'onafterprint'</span>, <span class="string">'onafterupdate'</span>, <span class="string">'onbeforeactivate'</span>, <span class="string">'onbeforecopy'</span>, <span class="string">'onbeforecut'</span>, <span class="string">'onbeforedeactivate'</span>,</span><br><span class="line">                <span class="string">'onbeforeeditfocus'</span>, <span class="string">'onbeforepaste'</span>, <span class="string">'onbeforeprint'</span>, <span class="string">'onbeforeunload'</span>, <span class="string">'onbeforeupdate'</span>, <span class="string">'onblur'</span>, <span class="string">'onbounce'</span>, <span class="string">'oncellchange'</span>, <span class="string">'onchange'</span>,</span><br><span class="line">                <span class="string">'onclick'</span>, <span class="string">'oncontextmenu'</span>, <span class="string">'oncontrolselect'</span>, <span class="string">'oncopy'</span>, <span class="string">'oncut'</span>, <span class="string">'ondataavailable'</span>, <span class="string">'ondatasetchanged'</span>, <span class="string">'ondatasetcomplete'</span>, <span class="string">'ondblclick'</span>,</span><br><span class="line">                <span class="string">'ondeactivate'</span>, <span class="string">'ondrag'</span>, <span class="string">'ondragend'</span>, <span class="string">'ondragenter'</span>, <span class="string">'ondragleave'</span>, <span class="string">'ondragover'</span>, <span class="string">'ondragstart'</span>, <span class="string">'ondrop'</span>, <span class="string">'onerror'</span>, <span class="string">'onerrorupdate'</span>,</span><br><span class="line">                <span class="string">'onfilterchange'</span>, <span class="string">'onfinish'</span>, <span class="string">'onfocus'</span>, <span class="string">'onfocusin'</span>, <span class="string">'onfocusout'</span>, <span class="string">'onhelp'</span>, <span class="string">'onkeydown'</span>, <span class="string">'onkeypress'</span>, <span class="string">'onkeyup'</span>, <span class="string">'onlayoutcomplete'</span>,</span><br><span class="line">                <span class="string">'onload'</span>, <span class="string">'onlosecapture'</span>, <span class="string">'onmousedown'</span>, <span class="string">'onmouseenter'</span>, <span class="string">'onmouseleave'</span>, <span class="string">'onmousemove'</span>, <span class="string">'onmouseout'</span>, <span class="string">'onmouseover'</span>, <span class="string">'onmouseup'</span>, <span class="string">'onmousewheel'</span>,</span><br><span class="line">                <span class="string">'onmove'</span>, <span class="string">'onmoveend'</span>, <span class="string">'onmovestart'</span>, <span class="string">'onpaste'</span>, <span class="string">'onpropertychange'</span>, <span class="string">'onreadystatechange'</span>, <span class="string">'onreset'</span>, <span class="string">'onresize'</span>, <span class="string">'onresizeend'</span>, <span class="string">'onresizestart'</span>,</span><br><span class="line">                <span class="string">'onrowenter'</span>, <span class="string">'onrowexit'</span>, <span class="string">'onrowsdelete'</span>, <span class="string">'onrowsinserted'</span>, <span class="string">'onscroll'</span>, <span class="string">'onselect'</span>, <span class="string">'onselectionchange'</span>, <span class="string">'onselectstart'</span>, <span class="string">'onstart'</span>, <span class="string">'onstop'</span>,</span><br><span class="line">                <span class="string">'onsubmit'</span>, <span class="string">'onunload'</span>, <span class="string">'javascript'</span>, <span class="string">'script'</span>, <span class="string">'eval'</span>, <span class="string">'behaviour'</span>, <span class="string">'expression'</span>);</span><br><span class="line">            $skipstr = implode(<span class="string">'|'</span>, $skipkeys);</span><br><span class="line">            $value   = preg_replace(<span class="keyword">array</span>(<span class="string">"/($skipstr)/i"</span>), <span class="string">'.'</span>, $value);</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">"/^[\/|\s]?($allowtags)(\s+|$)/is"</span>, $value)) &#123;</span><br><span class="line">                $value = <span class="string">''</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $replaces[] = <span class="keyword">empty</span>($value) ? <span class="string">''</span> : <span class="string">"&lt;"</span> . str_replace(<span class="string">'&amp;quot;'</span>, <span class="string">'"'</span>, $value) . <span class="string">"&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $html = str_replace($searchs, $replaces, $html);</span><br><span class="line">    $html = htmlspecialchars($html);</span><br><span class="line">    <span class="keyword">return</span> $html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法总结是对尖括号,js各种事件名进行过滤.这里是对 注册的用户名执行,防止出现XSS.接着对$_data数组各种进行赋值,这个数组跟$data 的post参数数组有所不同,注意区分.</p>
<p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705175718145.png" alt="image-20200705175718145"></p>
<p>最后这里对密码 <strong>用原始获取的$password 拼接上面的 salt 进行md5</strong>.</p>
<p>接着找到Model类,allowField()方法执行.跟进.</p>
<h4 id="model-User-gt-allowField-gt-save"><a href="#model-User-gt-allowField-gt-save" class="headerlink" title="# model\User-&gt;allowField()-&gt;save()"></a># model\User-&gt;allowField()-&gt;save()</h4><p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705175805854.png" alt="image-20200705175805854"></p>
<p>设置允许写入的字段.传入参数true,简单的设置了field属性为true然后返回对象,继续执行<strong>save($_data) , 传入上面赋值的 $_data数组</strong></p>
<p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705181927352.png" alt="image-20200705181927352"></p>
<p>将$_data数组传入过来成为$data.</p>
<p><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705182134447.png" alt="image-20200705182134447"></p>
<p>对数组中的值进行自动验证,验证通过,再遍历数组,执行setAttr()方法. 这个方法的目的是为了针对某些属性的设置,去拼接特定的方法,<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705182345894.png" alt="image-20200705182345894"></p>
<p>如这个位置,去按照格式拼接一个到当前数据对象salt的特定方法为setSaltAttr,但是我们可以发现当前的模型<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705182442062.png" alt="image-20200705182442062"></p>
<p>是没有这个方法的,只有Regtime和Userip有这个方法.所以等一下后面在针对这2个属性的时候应该会执行对应的模型方法.</p>
<p><strong>如果没有这个方法,就是简单的将刚刚传进来的$_data数组,存储到模型对象的data数组里,也就是$this-&gt;data[key] = value,最终执行完的结果就是这个User模型对象 的 <u>data属性数组</u>都被$_data数组的值补充满了.</strong></p>
<p>然后回到save()函数来到1088行. 自动完成属性为空,没执行任何操作.跳过.</p>
<p>1094行,获取$pk 主键.在模型中已经写了,直接获取到<strong>$pk=id.</strong><img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705183225072.png" alt="image-20200705183225072"></p>
<p>没有开启自动更新,直接跳到1163,<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705183958899.png" alt="image-20200705183958899"></p>
<p>$this-&gt;insert也是模型类里面定义的.跟进autoCompleteData,结果就是又再次更新了$this-&gt;data[‘这两个字段’] 的值.</p>
<p>找到插入关键点.<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705210602783.png" alt="image-20200705210602783"></p>
<p>去到1180行,save()本方法本来只是保存数据对象到User模型类里面的data数组属性的,这个位置也顺便把保存了的属性一起插入到数据库中.</p>
<p>首先1180行,<strong>checkAllowField()</strong> 传入数组 [‘regtime’,’userip’] 这个方法的作用是获取了当前表 User的字段信息,共有29个列名(字段名)赋值给$allowFields.<img src="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/image-20200705214118197.png" alt="image-20200705214118197"></p>
<p>关键语句:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$result = <span class="keyword">$this</span>-&gt;getQuery()-&gt;strict(<span class="keyword">false</span>)-&gt;field($allowFields)-&gt;insert(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;replace, <span class="keyword">false</span>, $sequence);</span><br></pre></td></tr></table></figure>

<p>首先获取查询对象,然后最后将$this-&gt;data都插入进去.save方法也完结了.回到reg()方法.最后json返回200注册成功.注册方法就结束了,后面框架剩余的方法上篇有讲过这里就不跟了.</p>
<h3 id="The-End-总结"><a href="#The-End-总结" class="headerlink" title="# The End 总结"></a># The End 总结</h3><p>​    <u><strong><em>跟了这么久发现好像其实没什么东西,仅仅只是把我们输入的post参数经过过滤器过滤,然后username再经过removexss方法进行过滤,然后就插入到数据库中.分析途中发现 我把username输入的单引号,是不会被转义的,会直接插入到数据库中,但是双引号是会被removexss给转义变成html实体,&amp;quot 插入到数据库是脏数据.注册流程也分析完毕.下一篇开始分析登录过程并且挖掘调试任意用户登录漏洞.</em></strong></u></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Dj3ntG0d</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://dj3ntg0d.github.io/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/">https://dj3ntg0d.github.io/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95--%E6%B3%A8%E5%86%8C%E7%AF%87/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/07/05/Laysns%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E5%8F%8A%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95-%E7%99%BB%E5%BD%95%E5%92%8C%E6%BC%8F%E6%B4%9E%E7%AF%87/"><img class="prev_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Laysns注册登录逻辑分析及任意用户登录--登录和漏洞篇</div></div></a></div><div class="next-post pull_right"><a href="/2020/06/23/Thinkphp5%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><img class="next_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Thinkphp5框架实现以及生命周期源码分析</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Dj3ntG0d</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script></body></html>